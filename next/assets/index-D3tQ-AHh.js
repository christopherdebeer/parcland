(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();class w{constructor(e={},t=null){this.canvasState=e,this.parentStateManager=t,this.childCanvasElements=new Map,this.canvasState.elements||(this.canvasState.elements=[]),this.canvasState.edges||(this.canvasState.edges=[]),this.canvasState.versionHistory||(this.canvasState.versionHistory=[]),this.selectedElementId=null,this.activeGesture=null,this.mode="navigate",this.elementNodesMap={},this.edgeNodesMap={},this.edgeLabelNodesMap={},this.viewState={scale:1,translateX:0,translateY:0},this.saveTimeout=null,this.debounceSaveDelay=500,this.tokenKey="PARC.LAND/BKPK_TOKEN",this.listeners=new Map,this.controller=null,this.setupHandleNotifications()}setupHandleNotifications(){this.notifyResizeHandlePointerDown=()=>{},this.notifyScaleHandlePointerDown=()=>{},this.notifyReorderHandlePointerDown=()=>{},this.notifyTypeHandlePointerDown=()=>{},this.notifyRotateHandlePointerDown=()=>{},this.notifyEdgeHandlePointerDown=()=>{}}setController(e){this.controller=e}getController(){return this.controller}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const s=this.listeners.get(e);if(!s)return;const n=s.indexOf(t);n!==-1&&s.splice(n,1)}}notify(e,t){if(!this.listeners.has(e))return;[...this.listeners.get(e)].forEach(n=>{try{n(t)}catch(a){console.error(`Error in ${e} listener:`,a)}})}get elements(){return this.canvasState.elements||[]}get edges(){return this.canvasState.edges||[]}findElementById(e){return e?this.elements.find(t=>t.id===e):null}findEdgeElementById(e){return e?this.edges.find(t=>t.id===e):null}findElementOrEdgeById(e){return this.findElementById(e)||this.findEdgeElementById(e)}findEdgesByElementId(e){return e?this.edges.filter(t=>t.source===e||t.target===e):[]}registerChildCanvas(e,t){this.childCanvasElements.set(e,t),this.notify("child-canvas-registered",{elementId:e,childCanvasId:t})}getChildCanvasState(e){const t=this.childCanvasElements.get(e);return t?{canvasId:t,sourceElementId:e,elements:[],edges:[]}:null}addElement(e){return e.id||(e.id="el-"+Date.now()),this.canvasState.elements.push(e),this.notify("element-added",e),e.id}updateElement(e,t){const s=this.findElementById(e);return s?(Object.assign(s,t),this.notify("element-updated",{id:e,element:s}),!0):!1}removeElementById(e){if(!e)return!1;const t=this.canvasState.elements.length;return this.canvasState.elements=this.canvasState.elements.filter(s=>s.id!==e),t!==this.canvasState.elements.length?(this.elementNodesMap[e]&&(this.elementNodesMap[e].remove(),delete this.elementNodesMap[e]),this.findEdgesByElementId(e).forEach(n=>{this.removeEdgeById(n.id)}),this.childCanvasElements.has(e)&&this.childCanvasElements.delete(e),this.notify("element-removed",e),this.selectedElementId===e&&this.clearSelection(),!0):!1}addEdge(e){return e.id||(e.id="edge-"+Date.now()),this.canvasState.edges.push(e),this.notify("edge-added",e),e.id}updateEdge(e,t){const s=this.findEdgeElementById(e);return s?(Object.assign(s,t),this.notify("edge-updated",{id:e,edge:s}),!0):!1}removeEdgeById(e){if(!e)return!1;const t=this.canvasState.edges.length;return this.canvasState.edges=this.canvasState.edges.filter(s=>s.id!==e),t!==this.canvasState.edges.length?(this.edgeNodesMap[e]&&(this.edgeNodesMap[e].remove(),delete this.edgeNodesMap[e]),this.edgeLabelNodesMap&&this.edgeLabelNodesMap[e]&&(this.edgeLabelNodesMap[e].remove(),delete this.edgeLabelNodesMap[e]),this.notify("edge-removed",e),this.selectedElementId===e&&this.clearSelection(),!0):!1}selectElement(e){this.selectedElementId!==e&&(this.selectedElementId=e,this.notify("selection-changed",e))}clearSelection(){this.selectedElementId&&(this.selectedElementId=null,this.notify("selection-changed",null))}setActiveGesture(e){this.activeGesture!==e&&(this.activeGesture=e,this.notify("gesture-changed",e))}clearActiveGesture(){this.activeGesture&&(this.activeGesture=null,this.notify("gesture-changed",null))}setViewState(e){const t={...this.viewState};Object.assign(this.viewState,e),JSON.stringify(t)!==JSON.stringify(this.viewState)&&this.notify("view-state-changed",this.viewState)}requestDrillIn(e){e.parentContext={elementId:e.sourceElementId,canvasId:this.canvasState.canvasId},this.notify("drill-in-requested",e)}serializeCanvas(){return JSON.stringify(this.canvasState)}saveCanvas(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>{this._saveCanvas()},this.debounceSaveDelay),this.saveCanvasLocalOnly()}async _saveCanvas(){this.saveCanvasLocalOnly();const e=this.getAuthToken();if(!e){console.warn("No auth token found, skipping API save");return}const t=this.canvasState.canvasId,s="websim";try{const a=await(await fetch(`https://c15r-parcland_backpack.web.val.run/${s}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:this.serializeCanvas()})).json();console.log(`Canvas ${t} saved to API`,a),this.notify("canvas-saved",{remote:!0,success:!0})}catch(n){console.error(`Error saving canvas ${t} to API:`,n),this.notify("canvas-saved",{remote:!0,success:!1,error:n})}}saveCanvasLocalOnly(){try{localStorage.setItem("myCanvasData_"+this.canvasState.canvasId,this.serializeCanvas()),this.notify("canvas-saved",{remote:!1,success:!0})}catch(e){console.error("Error saving to local storage:",e),this.notify("canvas-saved",{remote:!1,success:!1,error:e})}}async setBackpackItem(e,t){const s=this.getAuthToken();if(!s){console.warn("No auth token found, skipping API save");return}try{const a=await(await fetch(`https://c15r-parcland_backpack.web.val.run/parc.land/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:t})).json();return console.log(`Backpack item ${e} saved to API`,a),a}catch(n){throw console.error(`Error saving backpack item ${e} to API:`,n),n}}async getBackpackItem(e){const t=this.getAuthToken();if(!t)return console.warn("No auth token found, skipping API get"),null;try{const s=await fetch(`https://c15r-parcland_backpack.web.val.run/parc.land/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)throw new Error(`Failed to fetch item: ${s.status}`);return await s.json()}catch(s){return console.error(`Error getting backpack item ${e} from API:`,s),null}}async loadCanvas(e){const t=this.tokenKey;let s=localStorage.getItem(t);s||(localStorage.setItem(t,"TBC"),s="TBC");const n=localStorage.getItem("myCanvasData_"+e);try{const i=await fetch(`https://c15r-parcland_backpack.web.val.run/websim/${e}`,{headers:{Authorization:`Bearer ${s}`}});if(i.ok){const r=await i.json();return this.canvasState=r,this.notify("canvas-loaded",{remote:!0,success:!0}),r}else if(console.warn("Failed to load from API, fallback local"),n)try{const r=JSON.parse(n);return this.canvasState=r,this.notify("canvas-loaded",{remote:!1,success:!0}),r}catch(r){console.error("Error parsing local storage data:",r);const o={canvasId:e,elements:[],edges:[],versionHistory:[]};return this.canvasState=o,this.notify("canvas-loaded",{remote:!1,success:!1,error:r}),o}else{const r={canvasId:e,elements:[],edges:[],versionHistory:[]};return this.canvasState=r,this.notify("canvas-loaded",{remote:!1,success:!1,error:new Error("No local data found")}),r}}catch(a){if(console.error("Error loading from API",a),n)try{const i=JSON.parse(n);return this.canvasState=i,this.notify("canvas-loaded",{remote:!1,success:!0}),i}catch(i){console.error("Error parsing local storage data:",i);const r={canvasId:e,elements:[],edges:[],versionHistory:[]};return this.canvasState=r,this.notify("canvas-loaded",{remote:!1,success:!1,error:i}),r}else{const i={canvasId:e,elements:[],edges:[],versionHistory:[]};return this.canvasState=i,this.notify("canvas-loaded",{remote:!1,success:!1,error:a}),i}}}getAuthToken(){const e=this.tokenKey;let t=localStorage.getItem(e);return t||(localStorage.setItem(e,"TBC"),t="TBC"),t}async generateContent(e,t){const{type:s,id:n}=t,a=this.findEdgesByElementId(n).filter(r=>r.target===n).map(r=>({label:r.label,el:this.findElementById(r.source)}));console.log("Relevant edges",a);const i=this.getAuthToken();if(!i||i==="TBC")return await this.generateContentOld(e,s);try{const r=await fetch("https://c15r--2ac72f16e02411efa75ee6cdfca9ef9f.web.val.run",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:"claude-3-5-sonnet-20241022",max_tokens:4096,messages:[{role:"user",content:[{type:"text",text:`You will be given an element which is rendered into visual canvas. Either follow the user request or improve the provided content. The element content type should be <type>${s}</type>.

  Please provide your response in two parts:
  1. Your thought process about how to handle this request
  2. The actual result/content

  Here is the user request or content to process:

  <related-context>
  ${a.map(l=>{var d;return`<relation><label>${l.label||"undefined"}</label><content>${((d=l.el)==null?void 0:d.content)||""}</content></relation>`}).join(`
`)}
  </related-context>

  <current-content>
  ${e}
  </current-content>

  Respond only with valid json (do not wrap in code block) following the ApiResponse schema:

  <schema>
  interface ApiResponse {
    thoughts: string;
    result: string;
  }
  </schema>
  `}]}]})});console.log("response.ok",r.ok);const o=await r.text();console.log("AI response:",o);try{const l=JSON.parse(o);return this.notify("content-generated",{success:!0,elementId:n}),l.result}catch(l){return console.error("Failed to parse json response",l),this.notify("content-generated",{success:!1,error:l,elementId:n}),null}}catch(r){return console.error("Error fetching AI response:",r),this.notify("content-generated",{success:!1,error:r,elementId:n}),null}}async generateContentOld(e,t){try{const n=await(await fetch("/api/ai_completion",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({instructions:`You will be given an element which is rendered into a visual canvas.
  Either follow the user request or improve the provided content.
  The element content type should be <content-type>${t}</content-type>.

  Response should be valid JSON conforming to response schema:

  <schema>
  interface Response {
    thinking: string;
    result: string;
  }
  </schema>

  <user_request_or_content>
  ${e}
  </user_request_or_content>`})})).json();return this.notify("content-generated",{success:!0,legacy:!0}),n.result}catch(s){return console.error("Error fetching AI response (old fallback):",s),this.notify("content-generated",{success:!1,error:s,legacy:!0}),null}}async regenerateImage(e){try{const s=await(await fetch("https://c15r-replicate_base.web.val.run/generate",{method:"POST",headers:{Authorization:`Bearer ${this.getAuthToken()}`},body:JSON.stringify({prompt:e.content,width:e.width,height:e.height})})).json();return s&&s.imageUrl?(this.updateElement(e.id,{src:s.imageUrl}),this.saveCanvasLocalOnly(),this.notify("image-regenerated",{success:!0,elementId:e.id}),!0):(this.notify("image-regenerated",{success:!1,error:new Error("No image URL returned"),elementId:e.id}),!1)}catch(t){return console.error("Failed to regenerate image",t),this.notify("image-regenerated",{success:!1,error:t,elementId:e.id}),!1}}addVersionHistoryEntry(e="Canvas updated"){const t={timestamp:Date.now(),description:e,state:JSON.stringify(this.canvasState)};this.canvasState.versionHistory.push(t),this.canvasState.versionHistory.length>50&&(this.canvasState.versionHistory=this.canvasState.versionHistory.slice(-50)),this.notify("version-added",t)}restoreFromVersion(e){if(!this.canvasState.versionHistory||e<0||e>=this.canvasState.versionHistory.length)return!1;try{const t=this.canvasState.versionHistory[e],s=JSON.parse(t.state);return this.addVersionHistoryEntry("Before restore"),this.canvasState.elements=s.elements,this.canvasState.edges=s.edges,s.versionHistory=this.canvasState.versionHistory,s.canvasId=this.canvasState.canvasId,this.canvasState=s,this.notify("version-restored",{index:e,timestamp:t.timestamp}),!0}catch(t){return console.error("Error restoring from version:",t),!1}}getCanvasState(){return JSON.parse(JSON.stringify(this.canvasState))}destroy(){clearTimeout(this.saveTimeout),this.listeners.clear(),this.controller=null,this.parentStateManager=null,this.childCanvasElements.clear()}}class C{constructor(e,t){this.state=e,this.container=t.container,this.edgesLayer=t.edgesLayer,this.canvas=t.canvas,this.MAX_SCALE=10,this.MIN_SCALE=.1,this.stateSubscriptions=[this.state.subscribe("view-state-changed",()=>{this.updateCanvasTransform()})],this.loadLocalViewState()}loadLocalViewState(){try{const t="canvasViewState_"+(this.state.canvasState.canvasId||"default"),s=localStorage.getItem(t);if(s){const n=JSON.parse(s);this.state.setViewState({scale:n.scale||1,translateX:n.translateX||0,translateY:n.translateY||0})}}catch(e){console.warn("No local viewState found",e)}}saveLocalViewState(){try{const t="canvasViewState_"+(this.state.canvasState.canvasId||"default");localStorage.setItem(t,JSON.stringify(this.state.viewState))}catch(e){console.warn("Could not store local viewState",e)}}setInitialTransform({x:e,y:t,scale:s}){this.state.setViewState({translateX:e,translateY:t,scale:s}),this.updateCanvasTransform(),this.saveLocalViewState()}parentToChildCoordinates(e,t){var n;const s=(n=this.state.parentStateManager)==null?void 0:n.viewState;return s?{x:(e-s.translateX)/s.scale,y:(t-s.translateY)/s.scale}:{x:e,y:t}}childToParentCoordinates(e,t){var n;const s=(n=this.state.parentStateManager)==null?void 0:n.viewState;return s?{x:e*s.scale+s.translateX,y:t*s.scale+s.translateY}:{x:e,y:t}}updateCanvasTransform(){const{viewState:e}=this.state;this.container.style.transform=`translate(${e.translateX}px, ${e.translateY}px) scale(${e.scale})`,this.container.style.setProperty("--translateX",e.translateX),this.container.style.setProperty("--translateY",e.translateY),this.container.style.setProperty("--zoom",e.scale);const t=this.canvas.getBoundingClientRect(),s=t.width,n=t.height,a=-e.translateX/e.scale,i=-e.translateY/e.scale,r=s/e.scale,o=n/e.scale;this.edgesLayer.setAttribute("viewBox",`${a} ${i} ${r} ${o}`)}screenToCanvas(e,t){const{viewState:s}=this.state,n=this.canvas.getBoundingClientRect(),a=e-n.left,i=t-n.top,r={x:(a-s.translateX)/s.scale,y:(i-s.translateY)/s.scale};return this.state.parentStateManager?this.parentToChildCoordinates(r.x,r.y):r}canvasToScreen(e,t){const{viewState:s}=this.state,n=this.canvas.getBoundingClientRect();let a={x:e,y:t};return this.state.parentStateManager&&(a=this.childToParentCoordinates(e,t)),{x:a.x*s.scale+s.translateX+n.left,y:a.y*s.scale+s.translateY+n.top}}panCanvas(e,t){const{viewState:s}=this.state;this.state.setViewState({translateX:s.translateX+e,translateY:s.translateY+t}),this.saveLocalViewState()}zoomCanvas(e,t){const{viewState:s}=this.state,n=s.scale;e=Math.min(Math.max(e,this.MIN_SCALE),this.MAX_SCALE);const a=e-n;this.state.setViewState({scale:e,translateX:s.translateX-t.x*a,translateY:s.translateY-t.y*a}),this.saveLocalViewState()}handleWheelZoom(e){if(e.target.closest(".content")){const r=e.target.closest(".content");if(r.clientHeight!==r.scrollHeight)return}const t=-e.deltaY,a=this.state.viewState.scale*(1+t*.001),i=this.screenToCanvas(e.clientX,e.clientY);this.zoomCanvas(a,i)}handlePinchZoom(e,t,s){const n=Math.min(Math.max(e*t,this.MIN_SCALE),this.MAX_SCALE);this.zoomCanvas(n,s)}startCanvasPan(e,t){const{viewState:s}=this.state;return{initialTranslateX:s.translateX,initialTranslateY:s.translateY,startX:e,startY:t}}updateCanvasPan(e,t,s){const n=t-e.startX,a=s-e.startY;this.state.setViewState({translateX:e.initialTranslateX+n,translateY:e.initialTranslateY+a})}finishCanvasPan(){this.saveLocalViewState()}startCanvasPinch(e,t){const{viewState:s}=this.state,n=Math.hypot(t.x-e.x,t.y-e.y),a=(e.x+t.x)/2,i=(e.y+t.y)/2,r=this.screenToCanvas(a,i);return{initialScale:s.scale,initialDistance:n,pinchCenterScreen:{x:a,y:i},pinchCenterCanvas:r}}updateCanvasPinch(e,t,s){const n=Math.hypot(s.x-t.x,s.y-t.y);if(e.initialDistance===0)return;const a=n/e.initialDistance;this.handlePinchZoom(e.initialScale,a,e.pinchCenterCanvas)}setCanvasView(e,t,s){this.state.setViewState({scale:e,translateX:t,translateY:s}),this.saveLocalViewState()}resetCanvasView(){this.setCanvasView(1,0,0)}focusOnElement(e){const t=this.state.findElementById(e);if(!t)return;const s=this.canvas.getBoundingClientRect(),n=s.width/2,a=s.height/2;let i={x:t.x,y:t.y};this.state.parentStateManager&&(i=this.childToParentCoordinates(t.x,t.y)),this.state.setViewState({translateX:n-i.x*this.state.viewState.scale,translateY:a-i.y*this.state.viewState.scale}),this.saveLocalViewState()}handleResize(){this.updateCanvasTransform()}destroy(){this.stateSubscriptions.forEach(e=>e()),this.stateSubscriptions=[]}}class M{constructor(e,t,s={}){this.state=e,this.container=t.container,this.staticContainer=t.staticContainer,this.edgeManager=s.edgeManager,this.viewManager=s.viewManager,this.stateSubscriptions=[this.state.subscribe("element-updated",n=>{this.updateElementNodeById(n.id,n.element)}),this.state.subscribe("selection-changed",n=>{this.refreshAllElements()})]}createElementNode(e){const t=document.createElement("div");return t.classList.add("canvas-element"),t.dataset.elId=e.id,t}updateElementNode(e,t,s){this.applyPositionStyles(e,t),e.setAttribute("type",t.type),e.classList.remove("selected"),s&&e.classList.add("selected"),this.setElementContent(e,t),Array.from(e.querySelectorAll(".element-handle")).forEach(a=>a.remove()),s&&this.buildHandles(e,t)}updateElementNodeById(e,t){const s=this.state.elementNodesMap[e];if(s){const n=e===this.state.selectedElementId;this.updateElementNode(s,t,n)}}setElementContent(e,t){const s=e.dataset.type||"",n=e.dataset.content||"",a=e.dataset.src||"",i=t.src||"";if(s===t.type&&n===t.content&&a===i)return;console.log("Setting element content",t.id,t.type),e.dataset.type=t.type,e.dataset.content=t.content,e.dataset.src=i,e.innerHTML="",t.type==="text"?this.renderTextElement(e,t):t.type==="html"?this.renderHtmlElement(e,t):t.type==="markdown"?this.renderMarkdownElement(e,t):t.type==="img"?this.renderImageElement(e,t):t.type==="canvas-container"?this.renderCanvasContainerElement(e,t):t.type==="edit-prompt"&&this.renderEditPromptElement(e,t);const r=e.querySelector(".content");r&&(r.clientHeight<r.scrollHeight?r.classList.add("scroller"):r.classList.remove("scroller"))}renderTextElement(e,t){const s=document.createElement("p");s.classList.add("content"),s.textContent=t.content,s.style.color=t.color||"#000000",e.appendChild(s)}renderHtmlElement(e,t){const s=document.createElement("div");s.classList.add("content"),s.innerHTML=t.content,e.appendChild(s),this.executeScriptElements(t,s)}renderMarkdownElement(e,t){const s=document.createElement("div");s.classList.add("content"),s.innerHTML=marked.parse(t.content),s.style.color=t.color||"#000000",e.appendChild(s)}renderImageElement(e,t){const s=document.createElement("img");s.classList.add("content"),s.dataset.image_id=t.imgId||"",s.title=t.content,s.onerror=n=>{console.warn("Image failed to load",n)},!t.src&&!s.src&&this.requestImageRegeneration(t),s.src=t.src||`https://placehold.co/${Math.round(t.width)}x${Math.round(t.height)}?text=${encodeURIComponent(t.content)}&font=lora`,e.appendChild(s)}renderCanvasContainerElement(e,t){const s=document.createElement("div");s.classList.add("content"),s.classList.add("child-canvas-container"),s.style.position="relative",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="center",s.style.width="100%",s.style.height="100%",s.style.border="2px dashed #aaa",s.style.borderRadius="8px",s.style.backgroundColor="rgba(240, 240, 240, 0.5)",s.style.backdropFilter="blur(2px)";const n=document.createElement("div");if(n.style.flex="1",n.style.width="100%",n.style.position="relative",n.style.overflow="hidden",t.childCanvasState&&t.childCanvasState.elements&&t.childCanvasState.elements.length>0){const i=t.childCanvasState.elements.length,r=(t.childCanvasState.edges||[]).length;n.innerHTML=`
                <div style='font-size:0.9em; color: #666; text-align: center; padding: 10px;'>
                    <i class="fa-solid fa-diagram-project"></i>
                    <div>Child Canvas</div>
                    <div style='font-size:0.8em; color: #888;'>
                        ${i} element${i!==1?"s":""},
                        ${r} edge${r!==1?"s":""}
                    </div>
                </div>
            `}else n.innerHTML=`
                <div style='font-size:0.9em; color: #888; text-align: center; padding: 10px;'>
                    <i class="fa-solid fa-square-plus"></i>
                    <div>Empty Child Canvas</div>
                    <div style='font-size:0.8em;'>Click to add content</div>
                </div>
            `;const a=document.createElement("button");a.className="drill-in-button",a.innerHTML='<i class="fa-solid fa-arrow-down"></i> Drill In',a.onclick=i=>{i.stopPropagation();const r=t.childCanvasState||{canvasId:t.id+"_child",elements:[],edges:[]};this.state.requestDrillIn(r)},s.appendChild(a),e.appendChild(s)}renderEditPromptElement(e,t){const s=document.createElement("div");s.classList.add("content"),e.appendChild(s),e.editor||(e.editor=CodeMirror(s,{value:t.content||"",lineNumbers:!1,mode:"text",theme:"default",lineWrapping:!0,viewportMargin:1/0}));const n=document.createElement("div");n.classList.add("actions"),e.appendChild(n);const a=document.createElement("button");a.textContent="Save";const i=document.createElement("button");i.textContent="Delete";const r=document.createElement("button");r.textContent="Cancel",n.appendChild(r),n.appendChild(a),n.appendChild(i),i.onclick=()=>{console.log("edit-prompt delete target"),this.handleEditPromptDelete(t)},a.onclick=()=>{this.handleEditPromptSave(e,t)},r.onclick=()=>{this.handleEditPromptCancel(t)}}handleEditPromptDelete(e){const t=this.state.findElementOrEdgeById(e.target);this.state.removeElementById(t==null?void 0:t.id),this.state.removeEdgeById(t==null?void 0:t.id),this.state.removeElementById(e.id),this.refreshAllElements(),this.state.saveCanvas()}handleEditPromptSave(e,t){const s=e.editor.getValue(),n=this.state.findElementOrEdgeById(t.target);n&&(console.log(`[DEBUG] Saving edit prompt content to [${n.id}] as property [${t.property}]. with value: "${s}"`,n,t),n&&(n[t.property]=s,this.edgeManager&&this.edgeManager.renderEdges(),this.state.saveCanvas())),this.state.removeElementById(t.id),this.refreshAllElements()}handleEditPromptCancel(e){this.state.removeElementById(e.id),this.refreshAllElements(),this.state.saveCanvas()}executeScriptElements(e,t){const s=Array.from(t.querySelectorAll("script")),n=a=>(console.log("Loading script",a),new Promise((i,r)=>{a.onload=()=>i(),a.onerror=()=>r(new Error(`Failed to load script: ${a.src}`)),document.head.appendChild(a)}));for(const a of s)if(console.log("Encountered script",a),a.type!=="module"&&!a.getAttribute("src")&&a.textContent&&a.textContent.trim()){const i=a.textContent;new Function("element","controller","node",i)(e,this.state.getController(),t)}else n(a)}applyPositionStyles(e,t){const s=t.scale||1,n=t.rotation||0,a=Math.floor(t.zIndex)||1,i=t.blendMode||"normal";t.static?(e.style.position="fixed",e.style.left=(t.fixedLeft||0)+"%",e.style.top=(t.fixedTop||0)+"%",e.style.width=t.width*s+"px",e.style.height=t.height*s+"px",e.style.setProperty("--scale",a),e.style.setProperty("--scale",s),e.style.setProperty("--width",t.width*s+"px"),e.style.setProperty("--height",t.height*s+"px"),e.style.setProperty("--blend-mode",i),e.style.transform=`rotate(${n}deg) translate(calc(0px - var(--padding)), calc(0px - var(--padding)))`):(e.style.position="absolute",e.style.left=t.x-t.width*s/2+"px",e.style.top=t.y-t.height*s/2+"px",e.style.width=t.width*s+"px",e.style.height=t.height*s+"px",e.style.setProperty("--scale",a),e.style.setProperty("--scale",s),e.style.setProperty("--width",t.width*s+"px"),e.style.setProperty("--height",t.height*s+"px"),e.style.setProperty("--blend-mode",i),e.style.transform=`rotate(${n}deg) translate(calc(0px - var(--padding)), calc(0px - var(--padding)))`),this.edgeManager&&(this.state.findEdgesByElementId(t.id)||[]).length>0&&this.edgeManager.renderEdges()}buildHandles(e,t){[{className:"type-handle element-handle",icon:"fa-solid fa-font",handler:o=>this.typeHandlePointerDown(o)},{className:"scale-handle element-handle top-right",icon:"fa-solid fa-up-down-left-right",handler:o=>this.scaleHandlePointerDown(o)},{className:"reorder-handle bottom-left element-handle",icon:"fa-solid fa-layer-group",handler:o=>this.reorderHandlePointerDown(o)},{className:"resize-handle bottom-right element-handle",icon:"fa-solid fa-up-right-and-down-left-from-center",handler:o=>this.resizeHandlePointerDown(o)}].forEach(o=>{const l=document.createElement("div");l.className=o.className;const d=document.createElement("i");d.className=o.icon,l.appendChild(d),l.addEventListener("pointerdown",o.handler.bind(this)),e.appendChild(l)});const n=document.createElement("div");n.className="rotate-handle rotate-handle-position element-handle";const a=document.createElement("i");a.className="fa-solid fa-rotate",n.appendChild(a),n.addEventListener("pointerdown",o=>this.rotateHandlePointerDown(o)),e.appendChild(n);const i=document.createElement("div");i.className="edge-handle element-handle";const r=document.createElement("i");r.className="fa-solid fa-link",i.appendChild(r),i.addEventListener("pointerdown",o=>this.edgeHandlePointerDown(o)),e.appendChild(i)}renderElements(){console.log("renderElements()");const{elementNodesMap:e}=this.state,t=new Set(Object.keys(e)),s=new Set;this.state.elements.forEach(n=>{s.add(n.id);let a=e[n.id];a||(a=this.createElementNode(n),n.static?this.staticContainer.appendChild(a):this.container.appendChild(a),e[n.id]=a);const i=n.id===this.state.selectedElementId;try{this.updateElementNode(a,n,i)}catch(r){console.warn("[WARN] Error updating node",r,a,n)}}),t.forEach(n=>{s.has(n)||(e[n].remove(),delete e[n])}),this.edgeManager&&this.edgeManager.renderEdges()}createNewElement(e,t,s="markdown",n="",a=!1,i={}){const r="el-"+Date.now(),o={text:"New Text",img:"Realistic tree on white background",html:"<div>Hello World</div>",markdown:`# New Markdown
Some **content** here...`};let l=a?"canvas-container":s,d=n||o[l]||"Untitled";const g=this.state.viewState.scale||1,h={...i,id:r,x:e,y:t,width:(a?200:120)/g,height:(a?150:40)/g,rotation:0,type:l,content:d,versions:[],static:!1,childCanvasState:a?{canvasId:r+"_child",elements:[],edges:[],versionHistory:[]}:null};return this.state.addElement(h),this.state.selectElement(r),this.renderElements(),this.state.saveCanvas(),r}toggleStatic(e){const t=this.state.elementNodesMap[e.id];if(t){if(e.static){const s=t.getBoundingClientRect(),n=this.viewManager.screenToCanvas(s.left+s.width/2,s.top+s.height/2);e.x=n.x-e.width*(e.scale||1)/2,e.y=n.y-e.height*(e.scale||1)/2,e.static=!1,this.container.appendChild(t)}else{const s=t.getBoundingClientRect(),n=s.top/window.innerHeight*100,a=s.left/window.innerWidth*100;e.fixedTop=n,e.fixedLeft=a,e.static=!0,this.staticContainer.appendChild(t)}this.state.updateElement(e.id,e)}}requestImageRegeneration(e){this.state.regenerateImage(e)}refreshAllElements(){this.renderElements()}typeHandlePointerDown(e){e.stopPropagation(),this.state.notifyTypeHandlePointerDown(e)}resizeHandlePointerDown(e){e.stopPropagation(),this.state.notifyResizeHandlePointerDown(e)}scaleHandlePointerDown(e){e.stopPropagation(),this.state.notifyScaleHandlePointerDown(e)}rotateHandlePointerDown(e){e.stopPropagation(),this.state.notifyRotateHandlePointerDown(e)}reorderHandlePointerDown(e){e.stopPropagation(),this.state.notifyReorderHandlePointerDown(e)}edgeHandlePointerDown(e){e.stopPropagation(),this.state.notifyEdgeHandlePointerDown(e)}destroy(){this.stateSubscriptions.forEach(e=>e()),this.stateSubscriptions=[]}}class S{constructor(e,t,s={}){this.state=e,this.edgesLayer=t.edgesLayer,this.viewManager=s.viewManager,this.elementManager=s.elementManager,this.tempEdgeElements=new Map,this.stateSubscriptions=[this.state.subscribe("edge-added",n=>{this.renderSingleEdge(n)}),this.state.subscribe("edge-updated",n=>{this.updateEdgeById(n.id,n.edge)}),this.state.subscribe("edge-removed",n=>{this.removeEdgeFromDOM(n)}),this.state.subscribe("element-updated",()=>{this.renderEdges()}),this.state.subscribe("view-state-changed",()=>{this.renderEdges()})]}setupArrowheadMarker(){let e=this.edgesLayer.querySelector("defs");if(e||(e=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.edgesLayer.prepend(e)),!e.querySelector("#arrowhead")){const t=document.createElementNS("http://www.w3.org/2000/svg","marker");t.setAttribute("id","arrowhead"),t.setAttribute("markerWidth","10"),t.setAttribute("markerHeight","7"),t.setAttribute("refX","10"),t.setAttribute("refY","3.5"),t.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M0,0 L0,7 L10,3.5 Z"),s.setAttribute("fill","#ccc"),t.appendChild(s),e.appendChild(t)}}renderEdges(){console.log("renderEdges()"),this.setupArrowheadMarker(),this.state.edges.forEach(e=>{this.renderSingleEdge(e)}),this.cleanupOrphanedEdges()}renderSingleEdge(e){var n,a;const{edgeNodesMap:t}=this.state;let s=t[e.id];s||(s=document.createElementNS("http://www.w3.org/2000/svg","line"),s.setAttribute("stroke",((n=e.style)==null?void 0:n.color)||"#ccc"),s.setAttribute("stroke-width",((a=e.style)==null?void 0:a.thickness)||"2"),s.setAttribute("marker-end","url(#arrowhead)"),t[e.id]=s,this.edgesLayer.appendChild(s)),this.updateEdgePosition(e,s)}updateEdgeById(e,t){var n,a,i,r;const s=this.state.edgeNodesMap[e];s&&(s.setAttribute("stroke",((n=t.style)==null?void 0:n.color)||"#ccc"),s.setAttribute("stroke-width",((a=t.style)==null?void 0:a.thickness)||"2"),s.setAttribute("stroke-dasharray",(i=t.data)!=null&&i.meta?"5,5":((r=t.style)==null?void 0:r.dash)||""),this.updateEdgePosition(t,s))}updateEdgePosition(e,t){var d,g;if(!t)return;const s=this.state.findElementById(e.source),n=this.state.findElementById(e.target),a=s?null:this.state.findEdgeElementById(e.source),i=n?null:this.state.findEdgeElementById(e.target),r=this.state.edgeLabelNodesMap||{};let o,l;if((s||a)&&(n||i)){if(s&&n)o=this.computeIntersection(s,n),l=this.computeIntersection(n,s);else if(s&&i){const h=r[e.target];h&&(o=this.computeIntersection(s,{x:parseFloat(h.getAttribute("x")),y:parseFloat(h.getAttribute("y"))}),l={x:parseFloat(h.getAttribute("x")),y:parseFloat(h.getAttribute("y"))})}else if(a&&n){const h=r[e.source];h&&(o={x:parseFloat(h.getAttribute("x")),y:parseFloat(h.getAttribute("y"))},l=this.computeIntersection(n,{x:parseFloat(h.getAttribute("x")),y:parseFloat(h.getAttribute("y"))}))}else if(a&&i){const h=r[e.source],p=r[e.target];h&&p&&(o={x:parseFloat(h.getAttribute("x")),y:parseFloat(h.getAttribute("y"))},l={x:parseFloat(p.getAttribute("x")),y:parseFloat(p.getAttribute("y"))})}o&&l?(t.setAttribute("x1",o.x),t.setAttribute("y1",o.y),t.setAttribute("x2",l.x),t.setAttribute("y2",l.y),t.setAttribute("stroke-dasharray",(d=e.data)!=null&&d.meta?"5,5":((g=e.style)==null?void 0:g.dash)||""),this.updateEdgeLabel(e,o,l)):(this.state.removeEdgeById(e.id),t.remove())}else this.state.removeEdgeById(e.id),t.remove()}updateEdgeLabel(e,t,s){this.state.edgeLabelNodesMap||(this.state.edgeLabelNodesMap={});const n=e.label?e.label:"Edge";let a=this.state.edgeLabelNodesMap[e.id];a||(a=document.createElementNS("http://www.w3.org/2000/svg","text"),a.setAttribute("text-anchor","middle"),a.setAttribute("data-id",e.id),a.setAttribute("alignment-baseline","middle"),a.setAttribute("fill","#000"),a.style.fontSize="12px",this.state.edgeLabelNodesMap[e.id]=a,this.edgesLayer.appendChild(a));const i=(t.x+s.x)/2,r=(t.y+s.y)/2;a.setAttribute("x",i),a.setAttribute("y",r),a.textContent=n,this.state.selectedElementId===e.id?a.style.fill="red":a.style.fill="#000"}computeIntersection(e,t){const s=e.x,n=e.y,a=e.scale||1,i=(e.width||10)*a,r=(e.height||10)*a;let o=t.x-s,l=t.y-n;if(o===0&&l===0)return{x:s,y:n};const d=i/2,g=r/2;let h=1/0,p=1/0;o!==0&&(h=d/Math.abs(o)),l!==0&&(p=g/Math.abs(l));const c=Math.min(h,p),m=s+o*c,E=n+l*c;return{x:m,y:E}}cleanupOrphanedEdges(){const{edgeNodesMap:e,edgeLabelNodesMap:t,edges:s}=this.state,n=new Set(s.map(a=>a.id));e&&Object.keys(e).forEach(a=>{n.has(a)||(console.log("[DEBUG] Deleting orphaned edge node",a,e[a]),e[a].remove(),delete e[a])}),t&&Object.keys(t).forEach(a=>{n.has(a)||(console.log("[DEBUG] Deleting orphaned edge label",a,t[a]),t[a].remove(),delete t[a])})}removeEdgeFromDOM(e){const{edgeNodesMap:t,edgeLabelNodesMap:s}=this.state;t&&t[e]&&(t[e].remove(),delete t[e]),s&&s[e]&&(s[e].remove(),delete s[e])}startEdgeCreation(e){console.log("Starting edge creation...");const t=this.state.findElementById(e);if(!t)return null;const s="temp-edge-"+Date.now(),n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttribute("stroke","blue"),n.setAttribute("stroke-width","4"),n.setAttribute("stroke-dasharray","5,5"),n.setAttribute("x1",t.x),n.setAttribute("y1",t.y),n.setAttribute("x2",t.x),n.setAttribute("y2",t.y),this.tempEdgeElements.set(s,{sourceId:e,lineElement:n}),this.edgesLayer.appendChild(n),s}updateEdgeCreation(e,t,s){const n=this.tempEdgeElements.get(e);n&&(n.lineElement.setAttribute("x2",t),n.lineElement.setAttribute("y2",s))}finishEdgeCreation(e,t){const s=this.tempEdgeElements.get(e);return!s||(s.lineElement.remove(),this.tempEdgeElements.delete(e),!t||t===s.sourceId)?null:this.createNewEdge(s.sourceId,t,"")}cancelEdgeCreation(e){const t=this.tempEdgeElements.get(e);t&&(t.lineElement.remove(),this.tempEdgeElements.delete(e))}createNewEdge(e,t,s,n={},a={}){const i="edge-"+Date.now(),r={id:i,source:e,target:t,label:s,style:{...a},data:{...n}};return this.state.addEdge(r),i}destroy(){this.tempEdgeElements.forEach(e=>{e.lineElement.remove()}),this.tempEdgeElements.clear(),this.stateSubscriptions.forEach(e=>e()),this.stateSubscriptions=[]}}class b{constructor(e,t,s={}){this.state=e,this.domElements=t,this.viewManager=s.viewManager,this.elementManager=s.elementManager,this.edgeManager=s.edgeManager,this.uiManager=s.uiManager,this.lastTapTime={},this.lastTapPosition={x:0,y:0},this.pointerDownHandlers=new Map,this.pointerMoveHandlers=new Map,this.pointerUpHandlers=new Map,this.activeGesture=null,this.initialTouches=[],this.tempEventHandlers=[],this.gestureData={dragStartPos:{x:0,y:0},elementStartPos:{x:0,y:0},elementStartSize:{width:0,height:0},elementStartRotation:0,centerForRotation:{x:0,y:0},initialPinchDistance:0,initialCanvasScale:1,pinchCenterScreen:{x:0,y:0},pinchCenterCanvas:{x:0,y:0},activeEdgeCreation:null,initialTranslateX:0,initialTranslateY:0,elementPinchStartSize:{width:0,height:0},elementPinchStartCenter:{x:0,y:0},pinchCenterStartCanvas:{x:0,y:0},addMenuTapPosX:0,addMenuTapPosY:0},this.edgePointerMoveHandler=null,this.edgePointerUpHandler=null,this.DOUBLE_TAP_THRESHOLD=300,this.TAP_MOVE_TOLERANCE=10,this.stateSubscriptions=[this.state.subscribe("gesture-changed",n=>{this.activeGesture=n})]}setupEventListeners(){const{canvas:e,container:t,staticContainer:s,edgesLayer:n,modeBtn:a,drillUpBtn:i,contextMenu:r}=this.domElements;e.addEventListener("pointerdown",this.onPointerDownCanvas.bind(this)),e.addEventListener("pointermove",this.onPointerMoveCanvas.bind(this)),e.addEventListener("pointerup",this.onPointerUpCanvas.bind(this)),e.addEventListener("pointercancel",this.onPointerUpCanvas.bind(this)),e.addEventListener("wheel",this.onWheelCanvas.bind(this)),t.addEventListener("pointerdown",this.onPointerDownElement.bind(this)),t.addEventListener("pointermove",this.onPointerMoveElement.bind(this)),t.addEventListener("pointerup",this.onPointerUpElement.bind(this)),t.addEventListener("pointercancel",this.onPointerUpElement.bind(this)),s.addEventListener("pointerdown",this.onPointerDownElement.bind(this)),s.addEventListener("pointermove",this.onPointerMoveElement.bind(this)),s.addEventListener("pointerup",this.onPointerUpElement.bind(this)),s.addEventListener("pointercancel",this.onPointerUpElement.bind(this)),n.addEventListener("pointerdown",this.blockPropagation.bind(this)),n.addEventListener("pointerup",this.onPointerUpEdgeLayer.bind(this)),r.addEventListener("pointerdown",o=>{console.log("contextMenu"),o.stopPropagation()}),a.onclick=o=>{o.stopPropagation();const l=this.state.getController(),d=this.state.mode==="direct"?"navigate":"direct";l.switchMode(d)},i&&(i.onclick=()=>{this.state.getController().drillUp()}),this.registerHandleEventHandlers(),window.addEventListener("resize",()=>{this.viewManager.handleResize()}),e.addEventListener("contextmenu",o=>(o.preventDefault(),!1))}registerHandleEventHandlers(){this.state.notifyResizeHandlePointerDown=e=>{this.handleResizeHandlePointerDown(e)},this.state.notifyScaleHandlePointerDown=e=>{this.handleScaleHandlePointerDown(e)},this.state.notifyReorderHandlePointerDown=e=>{this.handleReorderHandlePointerDown(e)},this.state.notifyTypeHandlePointerDown=e=>{this.handleTypeHandlePointerDown(e)},this.state.notifyRotateHandlePointerDown=e=>{this.handleRotateHandlePointerDown(e)},this.state.notifyEdgeHandlePointerDown=e=>{this.handleEdgeHandlePointerDown(e)}}blockPropagation(e){console.log("[DEBUG] Blocking event propagation on",e.target),e.stopPropagation()}onPointerDownCanvas(e){if(this.uiManager.hideContextMenu(),!e.target.closest(".canvas-element")&&this.state.selectedElementId&&this.state.clearSelection(),this.initialTouches.push({id:e.pointerId,x:e.clientX,y:e.clientY}),this.initialTouches.length===1&&!this.activeGesture)this.state.setActiveGesture("pan"),this.gestureData.initialTranslateX=this.state.viewState.translateX,this.gestureData.initialTranslateY=this.state.viewState.translateY,this.domElements.canvas.setPointerCapture(e.pointerId),this.gestureData.dragStartPos={x:e.clientX,y:e.clientY};else if(this.initialTouches.length===2){const t=this.initialTouches[0],s=this.initialTouches[1];if(this.gestureData.initialPinchDistance=Math.hypot(s.x-t.x,s.y-t.y),this.gestureData.pinchCenterScreen={x:(t.x+s.x)/2,y:(t.y+s.y)/2},this.gestureData.pinchCenterCanvas=this.viewManager.screenToCanvas(this.gestureData.pinchCenterScreen.x,this.gestureData.pinchCenterScreen.y),this.state.mode==="direct"&&this.state.selectedElementId){this.state.setActiveGesture("pinch-element");const n=this.state.findElementById(this.state.selectedElementId);n&&(this.gestureData.elementPinchStartSize={width:n.width,height:n.height},this.gestureData.elementPinchStartCenter={x:n.x,y:n.y},this.gestureData.pinchCenterStartCanvas={x:this.gestureData.pinchCenterCanvas.x,y:this.gestureData.pinchCenterCanvas.y})}else this.state.setActiveGesture("pinch-canvas"),this.gestureData.initialCanvasScale=this.state.viewState.scale}}onPointerMoveCanvas(e){if(this.activeGesture){if(this.activeGesture==="pan"&&this.initialTouches.length===1){const t=this.initialTouches[0];if(t.id===e.pointerId){const s=e.clientX-t.x,n=e.clientY-t.y;this.state.setViewState({translateX:this.gestureData.initialTranslateX+s,translateY:this.gestureData.initialTranslateY+n}),this.viewManager.saveLocalViewState()}}else if((this.activeGesture==="pinch-canvas"||this.activeGesture==="pinch-element")&&this.initialTouches.length===2){const t=this.initialTouches.findIndex(r=>r.id===e.pointerId);t!==-1&&(this.initialTouches[t].x=e.clientX,this.initialTouches[t].y=e.clientY);const[s,n]=this.initialTouches,a=Math.hypot(n.x-s.x,n.y-s.y);if(this.gestureData.initialPinchDistance===0)return;const i=a/this.gestureData.initialPinchDistance;if(this.activeGesture==="pinch-canvas")this.viewManager.handlePinchZoom(this.gestureData.initialCanvasScale,i,this.gestureData.pinchCenterCanvas);else{const r=this.state.findElementById(this.state.selectedElementId);if(r&&r.static!==!0){const o=this.gestureData.elementPinchStartCenter.x-this.gestureData.pinchCenterStartCanvas.x,l=this.gestureData.elementPinchStartCenter.y-this.gestureData.pinchCenterStartCanvas.y,d=o*i,g=l*i;this.state.updateElement(r.id,{x:this.gestureData.pinchCenterStartCanvas.x+d,y:this.gestureData.pinchCenterStartCanvas.y+g,width:this.gestureData.elementPinchStartSize.width*i,height:this.gestureData.elementPinchStartSize.height*i})}}}}}onPointerUpCanvas(e){if(!e.target.closest(".canvas-element")){if(this.activeGesture==="create-edge"){console.log("[DEBUG] Edge creation in progress exiting canvas pointer up handler");return}console.log("onPointerUpCanvas(ev)",e),this.onPointerUpDoubleTap(e,"canvas"),this.state.clearActiveGesture(),this.initialTouches=[],this.state.mode==="direct"&&this.state.getController().switchMode("navigate")}}onPointerUpDoubleTap(e,t,s){const n=Date.now(),a=e.clientX,i=e.clientY,r=this.lastTapTime[t]||0,o=n-r,l=Math.hypot(a-this.lastTapPosition.x,i-this.lastTapPosition.y);if(o<this.DOUBLE_TAP_THRESHOLD&&l<this.TAP_MOVE_TOLERANCE)if(console.log("[DEBUG] Double tap detected"),e.stopPropagation(),s&&typeof s=="function")s(e,t);else if(e.target.closest("text")){const d=this.viewManager.screenToCanvas(a,i);console.log("[DEBUG] Double tap on edge label. Canvas coordinates:",d),this.handleEdgeLabelDoubleTap(e,d)}else if(e.target.closest(".canvas-element"))if(this.state.mode==="navigate")this.state.getController().switchMode("direct");else{const d=this.domElements.canvas.getBoundingClientRect();this.uiManager.buildContextMenu(this.state.selectedElementId),this.uiManager.showContextMenu(e.clientX-d.left,e.clientY-d.top)}else{const d=this.viewManager.screenToCanvas(a,i);console.log("[DEBUG] Double tap on canvas background. Canvas coordinates:",d),this.handleCanvasDoubleTap(d)}this.lastTapTime[t]=n,this.lastTapPosition={x:a,y:i}}handleCanvasDoubleTap(e){this.gestureData.addMenuTapPosX=e.x,this.gestureData.addMenuTapPosY=e.y;const t=prompt("Quick create markdown content?");t&&this.state.getController().createNewElement(e.x,e.y,"markdown",t)}handleEdgeLabelDoubleTap(e,t){const s=e.target.dataset.id;if(s){this.state.selectElement(s);const n=this.state.findEdgeElementById(s),a=this.state.getController(),i=a.createNewElement(t.x,t.y,"edit-prompt",n.label||"",!1,{target:n.id,property:"label"});a.switchMode("direct"),a.createNewEdge(i,n.id,"Editing...",{meta:!0})}}onWheelCanvas(e){this.viewManager.handleWheelZoom(e)}onPointerDownElement(e){const t=e.target,s=t.closest(".canvas-element");if(!s||(e.stopPropagation(),t.classList.contains("resize-handle")||t.classList.contains("rotate-handle")||t.classList.contains("reorder-handle")||t.classList.contains("scale-handle")||t.classList.contains("type-handle")||t.classList.contains("edge-handle")))return;const a=s.dataset.elId;this.state.selectedElementId!==a&&this.state.selectElement(a),this.gestureData.dragStartPos={x:e.clientX,y:e.clientY};const i=this.state.findElementById(a);i&&(this.gestureData.elementStartPos={x:i.x,y:i.y}),this.state.mode==="direct"&&this.state.setActiveGesture("move-element")}onPointerMoveElement(e){if(this.activeGesture){if(this.activeGesture==="move-element"){e.stopPropagation();const t=this.state.findElementById(this.state.selectedElementId);if(!t||t.static===!0)return;const s=e.clientX-this.gestureData.dragStartPos.x,n=e.clientY-this.gestureData.dragStartPos.y,a=this.gestureData.elementStartPos.x+s/this.state.viewState.scale,i=this.gestureData.elementStartPos.y+n/this.state.viewState.scale;this.state.updateElement(t.id,{x:a,y:i})}else if(this.activeGesture==="resize-element"){e.stopPropagation();const t=this.state.findElementById(this.state.selectedElementId);if(!t||t.static===!0)return;const s=(e.clientX-this.gestureData.dragStartPos.x)/this.state.viewState.scale,n=(e.clientY-this.gestureData.dragStartPos.y)/this.state.viewState.scale,a=Math.max(20,this.gestureData.elementStartSize.width+s),i=Math.max(20,this.gestureData.elementStartSize.height+n);this.state.updateElement(t.id,{width:a,height:i})}else if(this.activeGesture==="scale-element"){e.stopPropagation();const t=this.state.findElementById(this.state.selectedElementId);if(!t)return;const s=.5,n=(e.clientX-this.gestureData.dragStartPos.x)/this.state.viewState.scale*s,a=(e.clientY-this.gestureData.dragStartPos.y)/this.state.viewState.scale*s,i=Math.max((n+a)/2,.2);this.state.updateElement(t.id,{scale:i})}else if(this.activeGesture==="reorder-element"){e.stopPropagation();const t=this.state.findElementById(this.state.selectedElementId);if(!t)return;const s=(e.clientX-this.gestureData.dragStartPos.x)/this.state.viewState.scale,n=(e.clientY-this.gestureData.dragStartPos.y)/this.state.viewState.scale,r=Math.sqrt(s*s+n*n)*.1;this.state.updateElement(t.id,{zIndex:r})}else if(this.activeGesture==="rotate-element"){e.stopPropagation();const t=this.state.findElementById(this.state.selectedElementId);if(!t)return;const s=this.viewManager.screenToCanvas(e.clientX,e.clientY),n=this.viewManager.screenToCanvas(this.gestureData.dragStartPos.x,this.gestureData.dragStartPos.y),a=n.x-this.gestureData.centerForRotation.x,i=n.y-this.gestureData.centerForRotation.y,r=s.x-this.gestureData.centerForRotation.x,o=s.y-this.gestureData.centerForRotation.y,l=Math.atan2(i,a),h=(Math.atan2(o,r)-l)*(180/Math.PI),p=this.gestureData.elementStartRotation+h;this.state.updateElement(t.id,{rotation:p})}else if(this.activeGesture==="create-edge"&&(e.stopPropagation(),this.gestureData.activeEdgeCreation&&this.gestureData.activeEdgeCreation.tempLine)){const t=this.viewManager.screenToCanvas(e.clientX,e.clientY);this.gestureData.activeEdgeCreation.tempLine.setAttribute("x2",t.x),this.gestureData.activeEdgeCreation.tempLine.setAttribute("y2",t.y)}}}onPointerUpElement(e){if(this.activeGesture==="create-edge"){console.log("edge creation in progress exiting element pointer up handler");return}console.log("onPointerUpElement(ev)",e.target),this.onPointerUpDoubleTap(e,"element"),["move-element","resize-element","rotate-element","reorder-element","scale-element"].includes(this.activeGesture)&&(e.stopPropagation(),this.state.saveCanvas()),this.state.clearActiveGesture()}onPointerUpEdgeLayer(e){console.log("[DEBUG] Edges layer pointerup",e.target.dataset.id,e.target);const t=e.target.dataset.id;t&&this.onPointerUpDoubleTap(e,"edge",s=>{console.log("[DEBUG] Double click on edge (label?)",s.target),this.state.selectElement(t);const n=this.state.findEdgeElementById(s.target.dataset.id),a=this.viewManager.screenToCanvas(s.clientX,s.clientY),i=this.state.getController(),r=i.createNewElement(a.x,a.y,"edit-prompt",n.label||"",!1,{target:n.id,property:"label"});i.switchMode("direct"),i.createNewEdge(r,n.id,"Editing...",{meta:!0})})}handleResizeHandlePointerDown(e){if(e.stopPropagation(),this.state.mode!=="direct")return;const t=this.state.findElementById(this.state.selectedElementId);!t||t.static===!0||(this.state.setActiveGesture("resize-element"),this.domElements.container.setPointerCapture(e.pointerId),this.gestureData.dragStartPos={x:e.clientX,y:e.clientY},this.gestureData.elementStartSize={width:t.width,height:t.height},this.gestureData.elementStartPos={x:t.x,y:t.y})}handleScaleHandlePointerDown(e){if(e.stopPropagation(),this.state.mode!=="direct")return;const t=this.state.findElementById(this.state.selectedElementId);t&&(this.state.setActiveGesture("scale-element"),this.domElements.container.setPointerCapture(e.pointerId),this.gestureData.dragStartPos={x:e.clientX,y:e.clientY},this.gestureData.elementStartSize={width:t.width,height:t.height},this.gestureData.elementStartPos={x:t.x,y:t.y})}handleReorderHandlePointerDown(e){if(e.stopPropagation(),this.state.mode!=="direct")return;const t=this.state.findElementById(this.state.selectedElementId);t&&(this.state.setActiveGesture("reorder-element"),this.domElements.container.setPointerCapture(e.pointerId),this.gestureData.dragStartPos={x:e.clientX,y:e.clientY},this.gestureData.elementStartSize={width:t.width,height:t.height},this.gestureData.elementStartPos={x:t.x,y:t.y})}handleTypeHandlePointerDown(e){if(e.stopPropagation(),this.state.mode!=="direct"||!this.state.selectedElementId)return;const t=this.domElements.canvas.getBoundingClientRect();this.uiManager.buildContextMenu(this.state.selectedElementId),this.uiManager.showContextMenu(e.clientX-t.left,e.clientY-t.top)}handleRotateHandlePointerDown(e){if(e.stopPropagation(),this.state.mode!=="direct")return;const t=this.state.findElementById(this.state.selectedElementId);t&&(this.state.setActiveGesture("rotate-element"),this.domElements.container.setPointerCapture(e.pointerId),this.gestureData.elementStartRotation=t.rotation||0,this.gestureData.centerForRotation={x:t.x,y:t.y},this.gestureData.dragStartPos={x:e.clientX,y:e.clientY})}handleEdgeHandlePointerDown(e){if(e.stopPropagation(),this.state.mode!=="direct"||!this.state.selectedElementId)return;console.log("starting edge creation..."),this.state.setActiveGesture("create-edge");const t=this.state.selectedElementId,s=this.state.findElementById(t);if(s){const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("stroke","blue"),n.setAttribute("stroke-width","4"),n.setAttribute("stroke-dasharray","5,5"),n.setAttribute("x1",s.x),n.setAttribute("y1",s.y),n.setAttribute("x2",s.x),n.setAttribute("y2",s.y),this.gestureData.activeEdgeCreation={sourceId:t,tempLine:n},this.domElements.edgesLayer.appendChild(n)}this.edgePointerMoveHandler=this.onEdgePointerMove.bind(this),this.edgePointerUpHandler=this.onEdgePointerUp.bind(this),document.addEventListener("pointermove",this.edgePointerMoveHandler),document.addEventListener("pointerup",this.edgePointerUpHandler)}onEdgePointerMove(e){if(console.log("onEdgePointerMove(ev)"),this.activeGesture!=="create-edge"||!this.gestureData.activeEdgeCreation)return;const t=this.viewManager.screenToCanvas(e.clientX,e.clientY);this.gestureData.activeEdgeCreation.tempLine.setAttribute("x2",t.x),this.gestureData.activeEdgeCreation.tempLine.setAttribute("y2",t.y)}onEdgePointerUp(e){if(console.log("onEdgePointerUp(ev)",this.activeGesture,this.gestureData.activeEdgeCreation),this.activeGesture!=="create-edge"||!this.gestureData.activeEdgeCreation)return;const t=document.elementFromPoint(e.clientX,e.clientY);let s=t&&t.closest(".canvas-element");if(console.log("targetEl",t,s),s){const a=s.dataset.elId;a&&a!==this.gestureData.activeEdgeCreation.sourceId&&this.state.getController().createNewEdge(this.gestureData.activeEdgeCreation.sourceId,a,"")}this.gestureData.activeEdgeCreation.tempLine&&this.gestureData.activeEdgeCreation.tempLine.remove(),this.gestureData.activeEdgeCreation=null,this.state.clearActiveGesture(),document.removeEventListener("pointermove",this.edgePointerMoveHandler),document.removeEventListener("pointerup",this.edgePointerUpHandler),this.state.getController().renderAll(),this.state.saveCanvas()}destroy(){this.gestureData.activeEdgeCreation&&this.gestureData.activeEdgeCreation.tempLine&&this.gestureData.activeEdgeCreation.tempLine.remove(),this.edgePointerMoveHandler&&document.removeEventListener("pointermove",this.edgePointerMoveHandler),this.edgePointerUpHandler&&document.removeEventListener("pointerup",this.edgePointerUpHandler),this.stateSubscriptions.forEach(e=>e()),this.stateSubscriptions=[]}}class x{constructor(e,t,s={}){this.state=e,this.domElements=t,this.elementManager=s.elementManager,this.edgeManager=s.edgeManager,this.viewManager=s.viewManager,this.currentElForVersions=null,this.currentVersionIndex=0,this.activeEditTab="content",this.codeMirrorContent=null,this.codeMirrorSrc=null,this.initializeModalHandlers(),this.stateSubscriptions=[this.state.subscribe("selection-changed",n=>{n===null&&this.hideContextMenu()})]}initializeModalHandlers(){const{modalCancelBtn:e,modalSaveBtn:t,modalGenerateBtn:s,modalVersionsPrevBtn:n,modalVersionsNextBtn:a}=this.domElements;e.onclick=()=>{this.hideEditModal()},t.onclick=()=>{this.saveModalContent()},s.onclick=async()=>{await this.generateModalContent()},document.getElementById("modal-clear").onclick=()=>{this.clearModalContent()},document.getElementById("modal-copy").onclick=async()=>{await this.copyModalContentToClipboard()},n.onclick=()=>{this.navigateToPreviousVersion()},a.onclick=()=>{this.navigateToNextVersion()},document.getElementById("tab-content").onclick=()=>{this.switchModalTab("content")},document.getElementById("tab-src").onclick=()=>{this.switchModalTab("src")}}showContextMenu(e,t,s=null){const n=this.domElements.contextMenu;n.style.left=e+"px",n.style.top=t+"px",s&&this.buildContextMenu(s),n.style.display="flex"}hideContextMenu(){this.domElements.contextMenu.style.display="none"}buildContextMenu(e){const t=this.state.findElementById(e)||this.state.findEdgeElementById(e);if(!t)return;const s=this.domElements.contextMenu;s.innerHTML="";const n=document.createElement("div");n.classList.add("btn-container"),s.appendChild(n),[{type:"img",icon:"fa-solid fa-image"},{type:"text",icon:"fa-solid fa-font"},{type:"html",icon:"fa-solid fa-code"},{type:"markdown",icon:"fa-brands fa-markdown"},{type:"canvas-container",icon:"fa-regular fa-object-group"}].forEach(c=>{const m=document.createElement("button");m.innerHTML=`<i class="${c.icon}"></i>`,m.title=`Type: ${c.type}`,t.type===c.type&&m.classList.add("selected"),this.clickCapture(m,()=>{this.state.updateElement(t.id,{type:c.type}),this.hideContextMenu()}),n.appendChild(m)});const i=document.createElement("select");if(s.appendChild(i),["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"].forEach(c=>{const m=document.createElement("option");m.value=c,m.textContent=c,i.appendChild(m)}),i.value=t.blendMode||"normal",i.onchange=c=>{this.state.updateElement(t.id,{blendMode:c.target.value})},t.type==="img"){const c=document.createElement("button");c.innerHTML='<i class="fa-solid fa-arrow-rotate-right"></i> Regen',c.onclick=()=>{this.state.regenerateImage(t),this.hideContextMenu()},s.appendChild(c)}if(t.type==="text"||t.type==="markdown"){const c=document.createElement("input");c.type="color",c.value=t.color||"#000000",c.addEventListener("change",m=>{this.state.updateElement(t.id,{color:m.target.value})}),s.appendChild(c)}const o=document.createElement("button");if(o.innerHTML=t.static?"Unset Static":"Set Static",this.clickCapture(o,()=>{this.elementManager.toggleStatic(t),this.hideContextMenu()}),s.appendChild(o),t.type==="canvas-container"&&t.childCanvasState){const c=document.createElement("button");c.textContent="Open Child Canvas",this.clickCapture(c,()=>{this.hideContextMenu(),this.state.requestDrillIn(t.childCanvasState)}),s.appendChild(c)}const l=document.createElement("button");l.innerHTML='<i class="fa-solid fa-pen-to-square"></i> Edit',this.clickCapture(l,()=>{this.openEditModal(t),this.hideContextMenu()}),s.appendChild(l);const d=document.createElement("button");d.innerHTML='<i class="fa-solid fa-pen-to-square"></i> Edit inline',this.clickCapture(d,c=>{this.createEditElement(c,t,"content"),this.hideContextMenu()}),s.appendChild(d);const g=document.createElement("button");g.innerHTML='<i class="fa-solid fa-trash"></i> Delete',this.clickCapture(g,()=>{t.id.startsWith("edge-")?this.state.removeEdgeById(t.id):this.state.removeElementById(t.id),this.hideContextMenu()}),s.appendChild(g);const h=document.createElement("button");h.innerHTML='<i class="fa-solid fa-copy"></i> Duplicate',this.clickCapture(h,()=>{const c={...t};c.id="el-"+Date.now(),c.x+=20,c.y+=20,this.state.addElement(c),this.state.selectElement(c.id),this.hideContextMenu()}),s.appendChild(h);const p=document.createElement("span");p.innerHTML=t.id,s.appendChild(p)}clickCapture(e,t){e.addEventListener("pointerdown",s=>{s.stopPropagation(),e.setPointerCapture(s.pointerId)}),e.onclick=t}createEditElement(e,t,s){const n=this.viewManager.screenToCanvas(e.clientX,e.clientY),a=this.elementManager.createNewElement(n.x,n.y,"edit-prompt",t[s],!1,{target:t.id,property:s});this.state.getController().switchMode("direct"),this.edgeManager.createNewEdge(a,t.id,"Editing...",{meta:!0})}openEditModal(e){const{editModal:t,editorContentContainer:s,editorSrcContainer:n}=this.domElements;t.style.display="block",this.currentElForVersions=e,e.versions=e.versions||[],this.currentVersionIndex=e.versions.length,this.codeMirrorContent?this.codeMirrorContent.setOption("mode",this.getCodeMirrorMode(e.type)):this.codeMirrorContent=CodeMirror(s,{value:"",lineNumbers:!0,mode:this.getCodeMirrorMode(e.type),theme:"default",lineWrapping:!0}),this.codeMirrorSrc||(this.codeMirrorSrc=CodeMirror(n,{value:"",lineNumbers:!0,mode:"text",theme:"default",lineWrapping:!0})),e.type==="img"&&e.src?this.switchModalTab("src"):this.switchModalTab("content"),this.loadVersion(e,this.currentVersionIndex)}hideEditModal(){this.domElements.editModal.style.display="none"}switchModalTab(e){this.activeEditTab=e,e==="content"?(document.getElementById("tab-content").classList.add("active"),document.getElementById("tab-src").classList.remove("active"),document.getElementById("editor-content").style.display="block",document.getElementById("editor-src").style.display="none"):(document.getElementById("tab-src").classList.add("active"),document.getElementById("tab-content").classList.remove("active"),document.getElementById("editor-src").style.display="block",document.getElementById("editor-content").style.display="none")}loadVersion(e,t){if(e.versions){if(t<e.versions.length){const s=e.versions[t];this.codeMirrorContent.setValue(s.content)}else this.codeMirrorContent.setValue(e.content||"");this.codeMirrorSrc.setValue(e.src||""),this.currentVersionIndex=t,this.renderVersionInfo(e)}}renderVersionInfo(e){const t=e.versions.length+1,s=this.currentVersionIndex+1;this.currentVersionIndex<e.versions.length?this.domElements.modalVersionsInfo.textContent=`Viewing Older Version ${s} of ${t}`:this.domElements.modalVersionsInfo.textContent=`Viewing Current Version ${s} of ${t}`}navigateToPreviousVersion(){this.currentElForVersions&&this.currentVersionIndex>0&&(this.currentVersionIndex--,this.loadVersion(this.currentElForVersions,this.currentVersionIndex))}navigateToNextVersion(){this.currentElForVersions&&this.currentVersionIndex<this.currentElForVersions.versions.length&&(this.currentVersionIndex++,this.loadVersion(this.currentElForVersions,this.currentVersionIndex))}saveModalContent(){const e=this.state.findElementById(this.state.selectedElementId);if(e){if(this.activeEditTab==="content"){const t=this.codeMirrorContent.getValue();e.content&&(e.versions=e.versions||[],e.versions.push({content:e.content,timestamp:Date.now()})),e.content=t,e.type!=="img"&&(e.src=void 0)}else if(this.activeEditTab==="src"){const t=this.codeMirrorSrc.getValue();e.src=t}this.state.updateElement(e.id,e),this.hideEditModal()}}async generateModalContent(){const e=this.state.findElementById(this.state.selectedElementId);if(!e)return;this.clearModalError(),this.domElements.modalGenerateBtn.disabled=!0;const t=this.domElements.modalGenerateBtn.innerHTML;this.domElements.modalGenerateBtn.innerHTML='Generating... <i class="fa-solid fa-spinner fa-spin"></i>';try{let s;this.activeEditTab==="content"?s=this.codeMirrorContent.getValue():s=this.codeMirrorSrc.getValue();const a=await this.state.getController().generateContent(s,e);a?this.activeEditTab==="content"?this.codeMirrorContent.setValue(a):this.codeMirrorSrc.setValue(a):this.showModalError("No content generated or an error occurred.")}catch(s){console.error("Generate error",s),this.showModalError("An error occurred while generating content.")}finally{this.domElements.modalGenerateBtn.disabled=!1,this.domElements.modalGenerateBtn.innerHTML=t}}clearModalContent(){this.activeEditTab==="content"?this.codeMirrorContent.setValue(""):this.codeMirrorSrc.setValue("")}async copyModalContentToClipboard(){try{this.activeEditTab==="content"?await navigator.clipboard.writeText(this.codeMirrorContent.getValue()):await navigator.clipboard.writeText(this.codeMirrorSrc.getValue()),alert("Copied to clipboard!")}catch(e){console.error("Failed to copy:",e),this.showModalError("Failed to copy to clipboard.")}}clearModalError(){this.domElements.modalError.textContent=""}showModalError(e){this.domElements.modalError.textContent=e}getCodeMirrorMode(e){switch(e){case"html":return"htmlmixed";case"markdown":return"markdown";case"text":return"javascript";default:return"javascript"}}showConfirmation(e,t,s){confirm(e)?typeof t=="function"&&t():typeof s=="function"&&s()}showPrompt(e,t,s,n){const a=prompt(e,t);a!==null?typeof s=="function"&&s(a):typeof n=="function"&&n()}showNotification(e,t="info",s=3e3){const n=document.createElement("div");n.className=`notification notification-${t}`,n.textContent=e,n.style.position="fixed",n.style.bottom="20px",n.style.right="20px",n.style.padding="10px 20px",n.style.background=t==="error"?"#ff4444":"#4ad36a",n.style.color="white",n.style.borderRadius="4px",n.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",n.style.zIndex="9999",n.style.opacity="0",n.style.transition="opacity 0.3s ease-in-out",document.body.appendChild(n),setTimeout(()=>{n.style.opacity="1"},10),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>{document.body.removeChild(n)},300)},s)}createTooltip(e,t){e.title=t}destroy(){this.stateSubscriptions.forEach(e=>e()),this.stateSubscriptions=[],this.codeMirrorContent&&(this.codeMirrorContent=null),this.codeMirrorSrc&&(this.codeMirrorSrc=null)}}class f{constructor(e,t=null){this.parentController=t,this.childControllers=new Map,this.domElements=this.initializeDomElements(),this.stateManager=new w(e,t==null?void 0:t.stateManager),this.stateManager.setController(this),this.viewManager=new C(this.stateManager,this.domElements);const s={viewManager:this.viewManager};this.elementManager=new M(this.stateManager,this.domElements,s),s.elementManager=this.elementManager,this.edgeManager=new S(this.stateManager,this.domElements,s),s.edgeManager=this.edgeManager,this.uiManager=new x(this.stateManager,this.domElements,s),s.uiManager=this.uiManager,this.eventManager=new b(this.stateManager,this.domElements,s),this.setupStateSubscriptions(),this.initialize(),y.register(e.canvasId,this)}initializeDomElements(){return{canvas:document.getElementById("canvas"),container:document.getElementById("canvas-container"),staticContainer:document.getElementById("static-container"),contextMenu:document.getElementById("context-menu"),modeBtn:document.getElementById("mode"),editModal:document.getElementById("edit-modal"),drillUpBtn:document.getElementById("drillUp"),edgesLayer:document.getElementById("edges-layer"),editorContentContainer:document.getElementById("editor-content"),editorSrcContainer:document.getElementById("editor-src"),modalCancelBtn:document.getElementById("modal-cancel"),modalSaveBtn:document.getElementById("modal-save"),modalGenerateBtn:document.getElementById("modal-generate"),modalVersionsPrevBtn:document.getElementById("versions-prev"),modalVersionsNextBtn:document.getElementById("versions-next"),modalVersionsInfo:document.getElementById("versions-info"),modalError:document.getElementById("modal-error")}}setupStateSubscriptions(){this.stateSubscriptions=[this.stateManager.subscribe("drill-in-requested",e=>{this.drillIntoChildCanvas(e)})]}initialize(){this.parentController?(this.domElements.drillUpBtn.style.display="block",this.domElements.drillUpBtn.onclick=()=>this.drillUp()):this.domElements.drillUpBtn.style.display="none",this.domElements.modeBtn.onclick=e=>{e.stopPropagation();const t=this.stateManager.mode==="direct"?"navigate":"direct";this.switchMode(t)},this.switchMode("navigate"),this.viewManager.updateCanvasTransform(),this.eventManager.setupEventListeners(),this.renderAll()}renderAll(){this.elementManager.renderElements(),this.edgeManager.renderEdges()}switchMode(e){this.stateManager.mode=e,this.domElements.canvas.setAttribute("mode",e),this.domElements.modeBtn.innerHTML=`<i class="fa-solid fa-${e==="direct"?"hand":"arrows-alt"}"></i> ${e}`}detach(){this.domElements.canvas.style.display="none"}reattach(){this.domElements.canvas.style.display="block",this.viewManager.updateCanvasTransform(),this.renderAll()}drillIntoChildCanvas(e){e.parentElementId=e.sourceElementId;const t=new f(e,this);this.childControllers.set(e.canvasId,t);const s=this.findElementById(e.parentElementId);s&&t.viewManager.setInitialTransform({x:s.x,y:s.y,scale:this.viewManager.viewState.scale}),this.detach(),y.setActive(t),window.history.pushState({},"","?canvas="+e.canvasId)}hasChildCanvas(e){return this.childControllers.has(e)}drillUp(){this.parentController&&(this.detach(),y.setActive(this.parentController),this.parentController.reattach(),window.history.pushState({},"","?canvas="+this.parentController.stateManager.canvasState.canvasId))}createNewElement(e,t,s="markdown",n="",a=!1,i={}){return this.elementManager.createNewElement(e,t,s,n,a,i)}createNewEdge(e,t,s,n={},a={}){return this.edgeManager.createNewEdge(e,t,s,n,a)}saveCanvas(){this.stateManager.saveCanvas()}selectElement(e){this.stateManager.selectElement(e)}findElementById(e){return this.stateManager.findElementById(e)}findEdgeElementById(e){return this.stateManager.findEdgeElementById(e)}screenToCanvas(e,t){return this.viewManager.screenToCanvas(e,t)}openEditModal(e){this.uiManager.openEditModal(e)}showContextMenu(e,t,s){this.uiManager.showContextMenu(e,t,s)}hideContextMenu(){this.uiManager.hideContextMenu()}async generateContent(e,t){return this.stateManager.generateContent(e,t)}regenerateImage(e){this.stateManager.regenerateImage(e)}destroy(){this.stateSubscriptions.forEach(e=>e()),this.childControllers.forEach(e=>e.destroy()),this.childControllers.clear(),this.eventManager.destroy(),this.uiManager.destroy(),this.edgeManager.destroy(),this.elementManager.destroy(),this.viewManager.destroy(),y.controllers.delete(this.stateManager.canvasState.canvasId)}}class I{constructor(){this.activeController=null,this.controllers=new Map}setActive(e){this.activeController=e,window.activeCanvasController=e}getActive(){return this.activeController}register(e,t){this.controllers.set(e,t)}get(e){return this.controllers.get(e)}}const y=new I,P=async()=>{const u="PARC.LAND/BKPK_TOKEN";let s=new URLSearchParams(window.location.search).get("token")||localStorage.getItem(u);return s||(localStorage.setItem(u,"TBC"),s="TBC"),s};async function D(){const u=new URLSearchParams(window.location.search),e=u.get("canvas")||"canvas-002";u.get("token");let t={canvasId:e,elements:[],edges:[],versionHistory:[]};t=await v(t);const s=new f(t);y.setActive(s),window.addEventListener("resize",()=>{const n=y.getActive();n&&n.viewManager.handleResize()}),window.addEventListener("popstate",n=>{const i=new URLSearchParams(window.location.search).get("canvas");if(i){const r=y.get(i);if(r){const o=y.getActive();o&&o.detach(),r.reattach(),y.setActive(r)}else T(i).then(o=>{const l=new f(o);y.register(i,l),y.setActive(l)})}})}async function v(u){const e=localStorage.getItem("myCanvasData_"+u.canvasId),t=await P();try{const n=await fetch(`https://c15r-parcland_backpack.web.val.run/websim/${u.canvasId}`,{headers:{Authorization:`Bearer ${t}`}});return n.ok?await n.json():(console.warn("Failed to load from API, fallback local"),e?JSON.parse(e):u)}catch(s){return console.error("Error loading from API",s),e?JSON.parse(e):u}}async function T(u){return await v({canvasId:u,elements:[],edges:[],versionHistory:[]})}document.addEventListener("DOMContentLoaded",D);
