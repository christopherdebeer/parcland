(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();class y{constructor(t,e=null){u=this,this.canvasState=t,this.canvasState.edges||(this.canvasState.edges=[]),this.parentController=e,this.selectedElementId=null,this.activeGesture=null,this.initialTouches=[],this.activeEditTab="content",this.edgeBeingEdited=null,this.viewState={scale:1,translateX:0,translateY:0},this.elementNodesMap={},this.edgeNodesMap={},this.canvas=document.getElementById("canvas"),this.container=document.getElementById("canvas-container"),this.staticContainer=document.getElementById("static-container"),this.contextMenu=document.getElementById("context-menu"),this.modeBtn=document.getElementById("mode"),this.editModal=document.getElementById("edit-modal"),this.drillUpBtn=document.getElementById("drillUp"),this.edgesLayer=document.getElementById("edges-layer"),this.editorContentContainer=document.getElementById("editor-content"),this.editorSrcContainer=document.getElementById("editor-src"),this.modalCancelBtn=document.getElementById("modal-cancel"),this.modalSaveBtn=document.getElementById("modal-save"),this.modalGenerateBtn=document.getElementById("modal-generate"),this.modalVersionsPrevBtn=document.getElementById("versions-prev"),this.modalVersionsNextBtn=document.getElementById("versions-next"),this.modalVersionsInfo=document.getElementById("versions-info"),this.modalError=document.getElementById("modal-error"),this.dragStartPos={x:0,y:0},this.elementStartPos={x:0,y:0},this.elementStartSize={width:0,height:0},this.elementStartRotation=0,this.centerForRotation={x:0,y:0},this.initialPinchDistance=0,this.elementPinchStartSize={width:0,height:0},this.elementPinchStartCenter={x:0,y:0},this.pinchCenterStartCanvas={x:0,y:0},this.initialCanvasScale=1,this.pinchCenterScreen={x:0,y:0},this.pinchCenterCanvas={x:0,y:0},this.MAX_SCALE=10,this.MIN_SCALE=.1,this.activeEdgeCreation=null,this.codeMirrorContent=null,this.codeMirrorSrc=null,this.saveTimeout=null,this.debounceSaveDelay=500,this.tokenKey="PARC.LAND/BKPK_TOKEN",this.modes=["direct","navigate"],this.mode="navigate",this.switchMode("navigate"),this.loadLocalViewState(),this.setupEventListeners(),this.parentController?this.drillUpBtn.style.display="block":this.drillUpBtn.style.display="none",this.updateCanvasTransform(),this.renderElements()}blockPropagation(t){console.log("[DEBUG] Blocking event propagation on",t.target),t.stopPropagation()}setupEventListeners(){this.modeBtn.onclick=t=>{t.stopPropagation();const e=this.mode==="direct"?"navigate":"direct";this.switchMode(e)},this.drillUpBtn.onclick=()=>{this.parentController&&(this.detach(),u=this.parentController,u.reattach(),window.history.pushState({},"","?canvas="+u.canvasState.canvasId))},this.canvas.addEventListener("pointerdown",t=>this.onPointerDownCanvas(t)),this.canvas.addEventListener("pointermove",t=>this.onPointerMoveCanvas(t)),this.canvas.addEventListener("pointerup",t=>this.onPointerUpCanvas(t)),this.canvas.addEventListener("pointercancel",t=>this.onPointerUpCanvas(t)),this.canvas.addEventListener("wheel",t=>this.onWheelCanvas(t)),this.container.addEventListener("pointerdown",t=>this.onPointerDownElement(t)),this.container.addEventListener("pointermove",t=>this.onPointerMoveElement(t)),this.container.addEventListener("pointerup",t=>this.onPointerUpElement(t)),this.container.addEventListener("pointercancel",t=>this.onPointerUpElement(t)),this.staticContainer.addEventListener("pointerdown",t=>this.onPointerDownElement(t)),this.staticContainer.addEventListener("pointermove",t=>this.onPointerMoveElement(t)),this.staticContainer.addEventListener("pointerup",t=>this.onPointerUpElement(t)),this.staticContainer.addEventListener("pointercancel",t=>this.onPointerUpElement(t)),this.edgesLayer.addEventListener("pointerdown",this.blockPropagation),this.edgesLayer.addEventListener("pointerup",this.blockPropagation),this.edgesLayer.addEventListener("pointerup",t=>{console.log("[DEBUG] Edges layer pointerup",t.target.dataset.id,t.target);const e=t.target.dataset.id;e&&this.onPointerUpDoubleTap(t,"edge",n=>{console.log("[DEBUG] Double click on edge (label?)",n.target),this.selectedElementId=e;const s=this.findEdgeElementById(n.target.dataset.id),i=this.screenToCanvas(n.clientX,n.clientY),o=this.createNewElement(i.x,i.y,"edit-prompt",s.label||"",!1,{target:s.id,property:"label"});this.switchMode("direct"),this.createNewEdge(o,s.id,"Editing...",{meta:!0})})}),this.lastTapPosition={x:0,y:0},this.contextMenu.addEventListener("pointerdown",t=>{console.log("contextMenu"),t.stopPropagation()}),this.modalCancelBtn.onclick=()=>{this.editModal.style.display="none"},this.modalSaveBtn.onclick=()=>{const t=this.findElementById(this.selectedElementId);if(t){if(this.activeEditTab==="content"){const e=this.codeMirrorContent.getValue();t.content&&(t.versions=t.versions||[],t.versions.push({content:t.content,timestamp:Date.now()})),t.content=e,t.type!=="img"&&(t.src=void 0)}else if(this.activeEditTab==="src"){const e=this.codeMirrorSrc.getValue();t.src=e}this.updateElementNode(this.elementNodesMap[t.id],t,!0),this.saveCanvas()}this.editModal.style.display="none"},this.modalGenerateBtn.onclick=async()=>{const t=this.findElementById(this.selectedElementId);if(!t)return;this.clearModalError(),this.modalGenerateBtn.disabled=!0;const e=this.modalGenerateBtn.innerHTML;this.modalGenerateBtn.innerHTML='Generating... <i class="fa-solid fa-spinner fa-spin"></i>';try{let n;this.activeEditTab==="content"?n=this.codeMirrorContent.getValue():n=this.codeMirrorSrc.getValue();const s=await this.generateContent(n,t);s?this.activeEditTab==="content"?this.codeMirrorContent.setValue(s):this.codeMirrorSrc.setValue(s):this.showModalError("No content generated or an error occurred.")}catch(n){console.error("Generate error",n),this.showModalError("An error occurred while generating content.")}finally{this.modalGenerateBtn.disabled=!1,this.modalGenerateBtn.innerHTML=e}},document.getElementById("modal-clear").onclick=()=>{this.activeEditTab==="content"?this.codeMirrorContent.setValue(""):this.codeMirrorSrc.setValue("")},document.getElementById("modal-copy").onclick=async()=>{try{this.activeEditTab==="content"?await navigator.clipboard.writeText(this.codeMirrorContent.getValue()):await navigator.clipboard.writeText(this.codeMirrorSrc.getValue()),alert("Copied to clipboard!")}catch(t){console.error("Failed to copy:",t)}},this.modalVersionsPrevBtn.onclick=()=>{this.currentElForVersions&&this.currentVersionIndex>0&&(this.currentVersionIndex--,this.loadVersion(this.currentElForVersions,this.currentVersionIndex))},this.modalVersionsNextBtn.onclick=()=>{this.currentElForVersions&&this.currentVersionIndex<this.currentElForVersions.versions.length&&(this.currentVersionIndex++,this.loadVersion(this.currentElForVersions,this.currentVersionIndex))},document.getElementById("tab-content").onclick=()=>{this.activeEditTab="content",document.getElementById("tab-content").classList.add("active"),document.getElementById("tab-src").classList.remove("active"),document.getElementById("editor-content").style.display="block",document.getElementById("editor-src").style.display="none"},document.getElementById("tab-src").onclick=()=>{this.activeEditTab="src",document.getElementById("tab-src").classList.add("active"),document.getElementById("tab-content").classList.remove("active"),document.getElementById("editor-src").style.display="block",document.getElementById("editor-content").style.display="none"}}detach(){this.canvas.style.display="none"}reattach(){this.canvas.style.display="block",this.updateCanvasTransform(),this.renderElements()}switchMode(t){this.mode=t,this.canvas.setAttribute("mode",this.mode),this.modeBtn.innerHTML=`<i class="fa-solid fa-${this.mode==="direct"?"hand":"arrows-alt"}"></i> ${this.mode}`}loadLocalViewState(){try{const t="canvasViewState_"+(this.canvasState.canvasId||"default"),e=localStorage.getItem(t);if(e){const n=JSON.parse(e);this.viewState.scale=n.scale||1,this.viewState.translateX=n.translateX||0,this.viewState.translateY=n.translateY||0}}catch(t){console.warn("No local viewState found",t)}}saveLocalViewState(){try{const t="canvasViewState_"+(this.canvasState.canvasId||"default");localStorage.setItem(t,JSON.stringify(this.viewState))}catch(t){console.warn("Could not store local viewState",t)}}updateCanvasTransform(){this.container.style.transform=`translate(${this.viewState.translateX}px, ${this.viewState.translateY}px) scale(${this.viewState.scale})`,this.container.style.setProperty("--translateX",this.viewState.translateX),this.container.style.setProperty("--translateY",this.viewState.translateY),this.container.style.setProperty("--zoom",this.viewState.scale);const t=this.canvas.getBoundingClientRect(),e=t.width,n=t.height,s=-this.viewState.translateX/this.viewState.scale,i=-this.viewState.translateY/this.viewState.scale,o=e/this.viewState.scale,r=n/this.viewState.scale;this.edgesLayer.setAttribute("viewBox",`${s} ${i} ${o} ${r}`)}renderElements(){console.log("renderElements()");const t=new Set(Object.keys(this.elementNodesMap)),e=new Set;this.canvasState.elements.forEach(n=>{e.add(n.id);let s=this.elementNodesMap[n.id];s||(s=this.createElementNode(n),n.static?this.staticContainer.appendChild(s):this.container.appendChild(s),this.elementNodesMap[n.id]=s);const i=n.id===this.selectedElementId;try{this.updateElementNode(s,n,i)}catch(o){console.warn("[WARN] Error updating node",o,s,n)}}),t.forEach(n=>{e.has(n)||(this.elementNodesMap[n].remove(),delete this.elementNodesMap[n])}),this.renderEdges()}renderEdges(){console.log("renderEdges()");let t=this.edgesLayer.querySelector("defs");if(t||(t=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.edgesLayer.prepend(t)),!t.querySelector("#arrowhead")){const e=document.createElementNS("http://www.w3.org/2000/svg","marker");e.setAttribute("id","arrowhead"),e.setAttribute("markerWidth","10"),e.setAttribute("markerHeight","7"),e.setAttribute("refX","10"),e.setAttribute("refY","3.5"),e.setAttribute("orient","auto");const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M0,0 L0,7 L10,3.5 Z"),n.setAttribute("fill","#ccc"),e.appendChild(n),t.appendChild(e)}this.canvasState.edges.forEach(e=>{var s,i;let n=this.edgeNodesMap[e.id];n||(n=document.createElementNS("http://www.w3.org/2000/svg","line"),n.setAttribute("stroke",((s=e.style)==null?void 0:s.color)||"#ccc"),n.setAttribute("stroke-width",((i=e.style)==null?void 0:i.thickness)||"2"),n.setAttribute("marker-end","url(#arrowhead)"),this.edgeNodesMap[e.id]=n,this.edgesLayer.appendChild(n)),this.updateEdgePosition(e,n)}),Object.keys(this.edgeNodesMap).forEach(e=>{this.canvasState.edges.find(n=>n.id===e)||(console.log("[DEBUG] Deleting orphaned edge node",e,this.edgeNodesMap[e]),this.edgeNodesMap[e].remove(),delete this.edgeNodesMap[e])}),this.edgeLabelNodesMap&&Object.keys(this.edgeLabelNodesMap).forEach(e=>{this.canvasState.edges.find(n=>n.id===e)||(console.log("[DEBUG] Deleting orphaned edge label",e,this.edgeLabelNodesMap[e]),this.edgeLabelNodesMap[e].remove(),delete this.edgeLabelNodesMap[e])})}updateEdgePosition(t,e){var l,p;if(!e)return;const n=this.findElementById(t.source),s=this.findElementById(t.target),i=n?null:this.findEdgeElementById(t.source),o=s?null:this.findEdgeElementById(t.target);let r,a;if((n||i)&&(s||o)&&(r=this.computeIntersection(n||{x:parseFloat(this.edgeLabelNodesMap[t.source].getAttribute("x")),y:parseFloat(this.edgeLabelNodesMap[t.source].getAttribute("y"))},s||{x:parseFloat(this.edgeLabelNodesMap[t.target].getAttribute("x")),y:parseFloat(this.edgeLabelNodesMap[t.target].getAttribute("y"))}),a=this.computeIntersection(s||{x:parseFloat(this.edgeLabelNodesMap[t.target].getAttribute("x")),y:parseFloat(this.edgeLabelNodesMap[t.target].getAttribute("y"))},n||{x:parseFloat(this.edgeLabelNodesMap[t.source].getAttribute("x")),y:parseFloat(this.edgeLabelNodesMap[t.source].getAttribute("y"))})),r&&a){e.setAttribute("x1",r.x),e.setAttribute("y1",r.y),e.setAttribute("x2",a.x),e.setAttribute("y2",a.y),e.setAttribute("stroke-dasharray",(l=t.data)!=null&&l.meta?"5,5":((p=t.style)==null?void 0:p.dash)||"");const m=t.label?t.label:"Edge";this.edgeLabelNodesMap||(this.edgeLabelNodesMap={});let d=this.edgeLabelNodesMap[t.id];d||(d=document.createElementNS("http://www.w3.org/2000/svg","text"),d.setAttribute("text-anchor","middle"),d.setAttribute("data-id",t.id),d.setAttribute("alignment-baseline","middle"),d.setAttribute("fill","#000"),d.style.fontSize="12px",this.selectedElementId===t.id&&(d.style.fill="red"),this.edgeLabelNodesMap[t.id]=d,this.edgesLayer.appendChild(d));const c=(r.x+a.x)/2,h=(r.y+a.y)/2;d.setAttribute("x",c),d.setAttribute("y",h),d.textContent=m}else this.canvasState.edges=this.canvasState.edges.filter(m=>m.id!==t.id),e.remove()}createElementNode(t){const e=document.createElement("div");return e.classList.add("canvas-element"),e.dataset.elId=t.id,e}updateElementNode(t,e,n){this.applyPositionStyles(t,e),t.setAttribute("type",e.type),t.classList.remove("selected"),n&&t.classList.add("selected"),this.setElementContent(t,e),Array.from(t.querySelectorAll(".element-handle")).forEach(i=>i.remove()),n&&this.buildHandles(t,e)}executeScriptElements(t,e){const n=Array.from(e.querySelectorAll("script")),s=i=>(console.log("Loading script",i),new Promise((o,r)=>{i.onload=()=>o(),i.onerror=()=>r(new Error(`Failed to load script: ${src}`)),document.head.appendChild(i)}));for(const i of n)if(console.log("Encountered script",i),i.type!=="module"&&!i.getAttribute("src")&&i.textContent&&i.textContent.trim()){const o=i.textContent;new Function("element","controller","node",o)(t,this,e)}else s(i)}setElementContent(t,e){const n=t.dataset.type||"",s=t.dataset.content||"",i=t.dataset.src||"",o=e.src||"";if(n===e.type&&s===e.content&&i===o)return;if(console.log("Setting element content",e.id,e.type),t.dataset.type=e.type,t.dataset.content=e.content,t.dataset.src=o,t.innerHTML="",e.type==="text"){const a=document.createElement("p");a.classList.add("content"),a.textContent=e.content,a.style.color=e.color||"#000000",t.appendChild(a)}else if(e.type==="html"){const a=document.createElement("div");a.classList.add("content"),a.innerHTML=e.content,t.appendChild(a),this.executeScriptElements(e,a)}else if(e.type==="markdown"){const a=document.createElement("div");a.classList.add("content"),a.innerHTML=marked.parse(e.content),a.style.color=e.color||"#000000",t.appendChild(a)}else if(e.type==="img"){const a=document.createElement("img");a.classList.add("content"),a.dataset.image_id=e.imgId||"",a.title=e.content,a.onerror=l=>{console.warn("Image failed to load",l)},!e.src&&!a.src&&this.regenerateImage(e),a.src=e.src||`https://placehold.co/${Math.round(e.width)}x${Math.round(e.height)}?text=${encodeURIComponent(e.content)}&font=lora`,t.appendChild(a)}else if(e.type==="canvas-container"){const a=document.createElement("div");a.classList.add("content"),a.style.position="relative",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="center",a.style.justifyContent="center",a.style.width="100%",a.style.height="100%",a.style.border="1px dotted #ccc",a.style.fontStyle="italic",e.childCanvasState&&e.childCanvasState.elements&&e.childCanvasState.elements.length>0?a.innerHTML="<div style='font-size:0.8em; color: #555;'>Child Canvas Content Rendered</div>":a.innerHTML="<div style='font-size:0.8em; color: #555;'>Empty Child Canvas</div>";const l=document.createElement("button");l.textContent="Drill In",l.style.position="absolute",l.style.bottom="5px",l.style.right="5px",l.style.zIndex="10",l.onclick=p=>{p.stopPropagation();const m=new y(e.childCanvasState,this);this.detach(),u=m,window.history.pushState({},"","?canvas="+e.childCanvasState.canvasId)},a.appendChild(l),t.appendChild(a)}else if(e.type==="edit-prompt"){const a=document.createElement("div");a.classList.add("content"),t.appendChild(a),t.editor||(t.editor=CodeMirror(a,{value:e.content||"",lineNumbers:!1,mode:"text",theme:"default",lineWrapping:!0,viewportMargin:1/0}));const l=document.createElement("div");l.classList.add("actions"),t.appendChild(l);const p=document.createElement("button");p.textContent="Save";const m=document.createElement("button");m.textContent="Delete";const d=document.createElement("button");d.textContent="Cancel",l.appendChild(d),l.appendChild(p),l.appendChild(m),m.onclick=()=>{console.log("edit-prompt delete target");const c=this.findElementOrEdgeById(e.target);this.canvasState.elements=this.canvasState.elements.filter(h=>h.id!==(c==null?void 0:c.id)&&h.id!==e.id),this.canvasState.edges=this.canvasState.edges.filter(h=>h.id!==(c==null?void 0:c.id)),this.renderElements(),this.saveCanvas()},p.onclick=()=>{const c=t.editor.getValue(),h=this.findElementOrEdgeById(e.target);h&&(console.log(`[DEBUG] Saving edit prompt content to [${h.id}] as property [${e.property}]. with value: "${c}"`,h,e),h&&(h[e.property]=c,this.renderEdges(),this.saveCanvas())),this.canvasState.elements=this.canvasState.elements.filter(v=>v.id!==e.id),this.renderElements()},d.onclick=()=>{this.canvasState.elements=this.canvasState.elements.filter(c=>c.id!==e.id),this.renderElements(),this.saveCanvas()}}const r=t.querySelector(".content");r.clientHeight<r.scrollHeight?r.classList.add("scroller"):r.classList.remove("scroller")}computeIntersection(t,e){const n=t.x,s=t.y,i=t.scale||1,o=(t.width||10)*i,r=(t.height||10)*i;let a=e.x-n,l=e.y-s;if(a===0&&l===0)return{x:n,y:s};const p=o/2,m=r/2;let d=1/0,c=1/0;a!==0&&(d=p/Math.abs(a)),l!==0&&(c=m/Math.abs(l));const h=Math.min(d,c),v=n+a*h,f=s+l*h;return{x:v,y:f}}buildHandles(t,e){[{className:"type-handle element-handle",icon:"fa-solid fa-font",handler:a=>this.typeHandlePointerDown(a)},{className:"scale-handle element-handle top-right",icon:"fa-solid fa-up-down-left-right",handler:a=>this.scaleHandlePointerDown(a)},{className:"reorder-handle bottom-left element-handle",icon:"fa-solid fa-layer-group",handler:a=>this.reorderHandlePointerDown(a)},{className:"resize-handle bottom-right element-handle",icon:"fa-solid fa-up-right-and-down-left-from-center",handler:a=>this.resizeHandlePointerDown(a)}].forEach(a=>{const l=document.createElement("div");l.className=a.className;const p=document.createElement("i");p.className=a.icon,l.appendChild(p),l.addEventListener("pointerdown",a.handler),t.appendChild(l)});const s=document.createElement("div");s.className="rotate-handle rotate-handle-position element-handle";const i=document.createElement("i");i.className="fa-solid fa-rotate",s.appendChild(i),s.addEventListener("pointerdown",a=>this.rotateHandlePointerDown(a)),t.appendChild(s);const o=document.createElement("div");o.className="edge-handle element-handle";const r=document.createElement("i");r.className="fa-solid fa-link",o.appendChild(r),o.addEventListener("pointerdown",a=>this.edgeHandlePointerDown(a)),t.appendChild(o)}applyPositionStyles(t,e){const n=e.scale||1,s=e.rotation||0,i=Math.floor(e.zIndex)||1,o=e.blendMode||"normal";e.static?(t.style.position="fixed",t.style.left=(e.fixedLeft||0)+"%",t.style.top=(e.fixedTop||0)+"%",t.style.width=e.width*n+"px",t.style.height=e.height*n+"px",t.style.setProperty("--scale",i),t.style.setProperty("--scale",n),t.style.setProperty("--width",e.width*n+"px"),t.style.setProperty("--height",e.height*n+"px"),t.style.setProperty("--blend-mode",o),t.style.transform=`rotate(${s}deg) translate(calc(0px - var(--padding)), calc(0px - var(--padding)))`):(t.style.position="absolute",t.style.left=e.x-e.width*n/2+"px",t.style.top=e.y-e.height*n/2+"px",t.style.width=e.width*n+"px",t.style.height=e.height*n+"px",t.style.setProperty("--scale",i),t.style.setProperty("--scale",n),t.style.setProperty("--width",e.width*n+"px"),t.style.setProperty("--height",e.height*n+"px"),t.style.setProperty("--blend-mode",o),t.style.transform=`rotate(${s}deg) translate(calc(0px - var(--padding)), calc(0px - var(--padding)))`),this.findEdgesByElementId(e.id),this.renderEdges()}selectElement(t){this.selectedElementId=t,this.renderElements()}findElementOrEdgeById(t){return console.log(`[DEBUG] findElementOrEdgeById("${t}")`),this.findElementById(t)||this.findEdgeElementById(t)}findElementById(t){return this.canvasState.elements.find(e=>e.id===t)}findEdgesByElementId(t){return this.canvasState.edges.filter(e=>e.source===t||e.target===t)}findEdgeElementById(t){return this.canvasState.edges.find(e=>e.id===t)}createNewElement(t,e,n="markdown",s="",i=!1,o={}){const r="el-"+Date.now(),a={text:"New text element",img:"Realistic tree on white background",html:"<div>Hello World</div>",markdown:`# New Markdown
Some **content** here...`};let l=i?"canvas-container":n,p=s||a[l]||"Untitled";const m=this.viewState.scale||1,d={...o,id:r,x:t,y:e,width:120/m,height:40/m,rotation:0,type:l,content:p,versions:[],static:!1,childCanvasState:i?{canvasId:r+"_child",elements:[],versionHistory:[]}:null};return this.canvasState.elements.push(d),this.selectElement(r),this.renderElements(),this.saveCanvas(),r}hideContextMenu(){this.contextMenu.style.display="none"}showContextMenu(t,e){this.contextMenu.style.left=t+"px",this.contextMenu.style.top=e+"px",this.contextMenu.style.display="flex"}onPointerDownCanvas(t){if(this.hideContextMenu(),!t.target.closest(".canvas-element")&&this.selectedElementId&&(this.selectedElementId=null,this.renderElements()),this.initialTouches.push({id:t.pointerId,x:t.clientX,y:t.clientY}),this.initialTouches.length===1&&!this.activeGesture)this.activeGesture="pan",this.initialTranslateX=this.viewState.translateX,this.initialTranslateY=this.viewState.translateY,this.canvas.setPointerCapture(t.pointerId),this.dragStartPos={x:t.clientX,y:t.clientY};else if(this.initialTouches.length===2){const e=this.initialTouches[0],n=this.initialTouches[1];if(this.initialPinchDistance=Math.hypot(n.x-e.x,n.y-e.y),this.pinchCenterScreen={x:(e.x+n.x)/2,y:(e.y+n.y)/2},this.pinchCenterCanvas=this.screenToCanvas(this.pinchCenterScreen.x,this.pinchCenterScreen.y),this.mode==="direct"&&this.selectedElementId){this.activeGesture="pinch-element";const s=this.findElementById(this.selectedElementId);s&&(this.elementPinchStartSize.width=s.width,this.elementPinchStartSize.height=s.height,this.elementPinchStartCenter={x:s.x,y:s.y},this.pinchCenterStartCanvas={x:this.pinchCenterCanvas.x,y:this.pinchCenterCanvas.y})}else this.activeGesture="pinch-canvas",this.initialCanvasScale=this.viewState.scale}}onPointerMoveCanvas(t){if(this.activeGesture){if(this.activeGesture==="pan"&&this.initialTouches.length===1){const e=this.initialTouches[0];if(e.id===t.pointerId){const n=t.clientX-e.x,s=t.clientY-e.y;this.viewState.translateX=this.initialTranslateX+n,this.viewState.translateY=this.initialTranslateY+s,this.updateCanvasTransform(),this.saveLocalViewState()}}else if((this.activeGesture==="pinch-canvas"||this.activeGesture==="pinch-element")&&this.initialTouches.length===2){const e=this.initialTouches.findIndex(r=>r.id===t.pointerId);e!==-1&&(this.initialTouches[e].x=t.clientX,this.initialTouches[e].y=t.clientY);const[n,s]=this.initialTouches,i=Math.hypot(s.x-n.x,s.y-n.y);if(this.initialPinchDistance===0)return;const o=i/this.initialPinchDistance;if(this.activeGesture==="pinch-canvas"){const r=this.viewState.scale,a=Math.min(Math.max(this.initialCanvasScale*o,this.MIN_SCALE),this.MAX_SCALE),l=a-r;this.viewState.scale=a,this.viewState.translateX-=this.pinchCenterCanvas.x*l,this.viewState.translateY-=this.pinchCenterCanvas.y*l,this.updateCanvasTransform(),this.saveLocalViewState()}else{const r=this.findElementById(this.selectedElementId);if(r&&r.static!==!0){const a=this.elementPinchStartCenter.x-this.pinchCenterStartCanvas.x,l=this.elementPinchStartCenter.y-this.pinchCenterStartCanvas.y,p=a*o,m=l*o;r.x=this.pinchCenterStartCanvas.x+p,r.y=this.pinchCenterStartCanvas.y+m,r.width=this.elementPinchStartSize.width*o,r.height=this.elementPinchStartSize.height*o,this.renderElements()}}}}}onPointerUpCanvas(t){if(!t.target.closest(".canvas-element")){if(this.activeGesture==="create-edge"){console.log("[ DEBUG] Edge creation in progress exiting canvas pointer up handler");return}console.log("onPointerUpCanvas(ev)",t),this.onPointerUpDoubleTap(t,"canvas"),this.activeGesture=null,this.initialTouches=[],this.mode==="direct"&&this.switchMode("navigate")}}onPointerUpDoubleTap(t,e,n){const s=Date.now(),i=t.clientX,o=t.clientY,r=this[`lastTapTime-${e}`]||0,a=s-r,l=Math.hypot(i-this.lastTapPosition.x,o-this.lastTapPosition.y);if(a<300&&l<10)if(console.log("[DEBUG] Double tap detected"),t.stopPropagation(),n&&typeof n=="function")n(t,e);else if(t.target.closest("text")){const d=this.screenToCanvas(i,o);console.log("[DEBUG] Double tap on edge label. Canvas coordinates:",d),this.addMenuTapPosX=d.x,this.addMenuTapPosY=d.y}else if(t.target.closest(".canvas-element"))if(this.mode==="navigate")this.switchMode("direct");else{const d=this.canvas.getBoundingClientRect();this.buildContextMenu(this.selectedElementId),this.showContextMenu(t.clientX-d.left,t.clientY-d.top)}else{const d=this.screenToCanvas(i,o);console.log("[DEBUG] Double tap on canvas background. Canvas coordinates:",d),this.addMenuTapPosX=d.x,this.addMenuTapPosY=d.y;const c=prompt("Quick create markdown content?");c&&this.createNewElement(d.x,d.y,"markdown",c)}this[`lastTapTime-${e}`]=s,this.lastTapPosition={x:i,y:o}}onWheelCanvas(t){if(t.target.closest(".content")){const l=t.target.closest(".content");if(l.clientHeight!==l.scrollHeight)return}const e=-t.deltaY,n=.001,s=this.viewState.scale,i=s*(1+e*n),o=Math.min(Math.max(i,this.MIN_SCALE),this.MAX_SCALE),r=o-s,a=this.screenToCanvas(t.clientX,t.clientY);console.log("[DEBUG] Wheel event fired on canvas",{ev:t,scale:o,prevScale:s,zoomCenter:a}),this.viewState.scale=o,this.viewState.translateX-=a.x*r,this.viewState.translateY-=a.y*r,this.updateCanvasTransform(),this.saveLocalViewState()}onPointerDownElement(t){const e=t.target,n=e.closest(".canvas-element");if(!n||(t.stopPropagation(),e.classList.contains("resize-handle")||e.classList.contains("rotate-handle")||e.classList.contains("reorder-handle")||e.classList.contains("scale-handle")||e.classList.contains("type-handle")||e.classList.contains("edge-handle")))return;const i=n.dataset.elId;this.selectedElementId!==i&&this.selectElement(i),this.dragStartPos={x:t.clientX,y:t.clientY};const o=this.findElementById(i);this.elementStartPos={x:o.x,y:o.y},this.mode==="direct"&&(this.activeGesture="move-element")}onPointerMoveElement(t){if(this.activeGesture){if(this.activeGesture==="move-element"){t.stopPropagation();const e=this.findElementById(this.selectedElementId);if(!e||e.static===!0)return;const n=t.clientX-this.dragStartPos.x,s=t.clientY-this.dragStartPos.y;e.x=this.elementStartPos.x+n/this.viewState.scale,e.y=this.elementStartPos.y+s/this.viewState.scale,this.updateElementNode(this.elementNodesMap[e.id],e,!0)}else if(this.activeGesture==="resize-element"){t.stopPropagation();const e=this.findElementById(this.selectedElementId);if(!e||e.static===!0)return;const n=(t.clientX-this.dragStartPos.x)/this.viewState.scale,s=(t.clientY-this.dragStartPos.y)/this.viewState.scale;e.width=Math.max(20,this.elementStartSize.width+n),e.height=Math.max(20,this.elementStartSize.height+s),this.updateElementNode(this.elementNodesMap[e.id],e,!0)}else if(this.activeGesture==="scale-element"){t.stopPropagation();const e=this.findElementById(this.selectedElementId);if(!e)return;const n=.5,s=(t.clientX-this.dragStartPos.x)/this.viewState.scale*n,i=(t.clientY-this.dragStartPos.y)/this.viewState.scale*n;e.scale=Math.max((s+i)/2,.2),this.updateElementNode(this.elementNodesMap[e.id],e,!0)}else if(this.activeGesture==="reorder-element"){t.stopPropagation();const e=this.findElementById(this.selectedElementId);if(!e)return;const n=(t.clientX-this.dragStartPos.x)/this.viewState.scale,s=(t.clientY-this.dragStartPos.y)/this.viewState.scale,i=Math.sqrt(n*n+s*s),o=.1;e.zIndex=i*o,this.updateElementNode(this.elementNodesMap[e.id],e,!0)}else if(this.activeGesture==="rotate-element"){t.stopPropagation();const e=this.findElementById(this.selectedElementId);if(!e)return;const n=this.screenToCanvas(t.clientX,t.clientY),s=this.screenToCanvas(this.dragStartPos.x,this.dragStartPos.y),i=s.x-this.centerForRotation.x,o=s.y-this.centerForRotation.y,r=n.x-this.centerForRotation.x,a=n.y-this.centerForRotation.y,l=Math.atan2(o,i),d=(Math.atan2(a,r)-l)*(180/Math.PI);e.rotation=this.elementStartRotation+d,this.updateElementNode(this.elementNodesMap[e.id],e,!0)}}}onPointerUpElement(t){if(this.activeGesture==="create-edge"){console.log("edge creation in progress exiting element pointer up handler");return}console.log("onPointerUpElement(ev)",t.target),this.onPointerUpDoubleTap(t,"element"),["move-element","resize-element","rotate-element","reorder-element","scale-element"].includes(this.activeGesture)&&(t.stopPropagation(),this.saveCanvas()),this.activeGesture=null}buildContextMenu(t){const e=this.findElementById(t)||this.findEdgeElementById(t);if(!e)return;this.contextMenu.innerHTML="";const n=document.createElement("div");n.classList.add("btn-container"),this.contextMenu.appendChild(n),[{type:"img",icon:"fa-solid fa-image"},{type:"text",icon:"fa-solid fa-font"},{type:"html",icon:"fa-solid fa-code"},{type:"markdown",icon:"fa-brands fa-markdown"},{type:"canvas-container",icon:"fa-regular fa-object-group"}].forEach(c=>{const h=document.createElement("button");h.innerHTML=`<i class="${c.icon}"></i>`,h.title=`Type: ${c.type}`,e.type===c.type&&h.classList.add("selected"),this.clickCapture(h,()=>{e.type=c.type,this.updateElementNode(this.elementNodesMap[e.id],e,e.id===this.selectedElementId),this.saveCanvas()}),n.appendChild(h)});const i=document.createElement("select");if(this.contextMenu.appendChild(i),["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"].forEach(c=>{const h=document.createElement("option");h.value=c,h.textContent=c,i.appendChild(h)}),i.value=e.blendMode||"normal",i.onchange=c=>{e.blendMode=c.target.value,this.updateElementNode(this.elementNodesMap[e.id],e,e.id===this.selectedElementId),this.saveCanvas()},e.type==="img"){const c=document.createElement("button");c.innerHTML='<i class="fa-solid fa-arrow-rotate-right"></i> Regen',c.onclick=()=>{this.regenerateImage(e),this.hideContextMenu()},this.contextMenu.appendChild(c)}if(e.type==="text"||e.type==="markdown"){const c=document.createElement("input");c.type="color",c.value=e.color||"#000000",c.addEventListener("change",h=>{e.color=h.target.value,this.updateElementNode(this.elementNodesMap[e.id],e,e.id===this.selectedElementId),this.saveCanvas()}),this.contextMenu.appendChild(c)}const r=document.createElement("button");if(r.innerHTML=e.static?"Unset Static":"Set Static",this.clickCapture(r,()=>{let c=this.elementNodesMap[e.id];this.updateElementNode(c,e,!0),this.toggleStatic(e),e.static?this.staticContainer.appendChild(c):this.container.appendChild(c),this.saveCanvas(),this.hideContextMenu()}),this.contextMenu.appendChild(r),e.type==="canvas-container"&&e.childCanvasState){const c=document.createElement("button");c.textContent="Open Child Canvas",this.clickCapture(c,()=>{this.hideContextMenu();const h=new y(e.childCanvasState,this);this.detach(),u=h,window.history.pushState({},"","?canvas="+e.childCanvasState.canvasId)}),this.contextMenu.appendChild(c)}const a=document.createElement("button");a.innerHTML='<i class="fa-solid fa-pen-to-square"></i> Edit',this.clickCapture(a,()=>{this.openEditModal(e),this.hideContextMenu()}),this.contextMenu.appendChild(a);const l=document.createElement("button");l.innerHTML='<i class="fa-solid fa-pen-to-square"></i> Edit inline',this.clickCapture(l,c=>{this.createEditElement(c,e,"content"),this.hideContextMenu()}),this.contextMenu.appendChild(l);const p=document.createElement("button");p.innerHTML='<i class="fa-solid fa-trash"></i> Delete',this.clickCapture(p,()=>{this.canvasState.elements=this.canvasState.elements.filter(c=>c.id!==e.id),this.elementNodesMap[e.id]&&(this.elementNodesMap[e.id].remove(),delete this.elementNodesMap[e.id]),this.selectedElementId=null,this.hideContextMenu(),this.saveCanvas()}),this.contextMenu.appendChild(p);const m=document.createElement("button");m.innerHTML='<i class="fa-solid fa-copy"></i> Duplicate',this.clickCapture(m,()=>{const c={...e};c.id="el-"+Date.now(),c.x+=20,c.y+=20,this.canvasState.elements.push(c),this.selectElement(c.id),this.hideContextMenu(),this.renderElements(),this.saveCanvas()}),this.contextMenu.appendChild(m);const d=document.createElement("span");d.innerHTML=e.id,this.contextMenu.appendChild(d)}createEditElement(t,e,n){const s=this.screenToCanvas(t.clientX,t.clientY),i=this.createNewElement(s.x,s.y,"edit-prompt",e[n],!1,{target:e.id,property:n});this.switchMode("direct"),this.createNewEdge(i,e.id,"Editing...",{meta:!0})}clickCapture(t,e){t.addEventListener("pointerdown",n=>{n.stopPropagation(),t.setPointerCapture(n.pointerId)}),t.onclick=e}toggleStatic(t){const e=this.elementNodesMap[t.id];if(e)if(t.static){const n=e.getBoundingClientRect(),s=this.screenToCanvas(n.left+n.width/2,n.top+n.height/2);t.x=s.x-t.width*(t.scale||1)/2,t.y=s.y-t.height*(t.scale||1)/2,t.static=!1}else{const n=e.getBoundingClientRect(),s=n.top/window.innerHeight*100,i=n.left/window.innerWidth*100;t.fixedTop=s,t.fixedLeft=i,t.static=!0}}screenToCanvas(t,e){const n=t-this.canvas.offsetLeft,s=e-this.canvas.offsetTop;return{x:(n-this.viewState.translateX)/this.viewState.scale,y:(s-this.viewState.translateY)/this.viewState.scale}}async regenerateImage(t){try{const n=await(await fetch("https://c15r-replicate_base.web.val.run/generate",{method:"POST",headers:{Authorization:`Bearer ${this.getAuthToken()}`},body:JSON.stringify({prompt:t.content,width:t.width,height:t.height})})).json();t.src=n.imageUrl,this.saveCanvasLocalOnly(),this.renderElements()}catch(e){console.error("Failed to regenerate image",e)}}openEditModal(t){this.editModal.style.display="block",this.currentElForVersions=t,t.versions=t.versions||[],this.currentVersionIndex=t.versions.length,this.codeMirrorContent?this.codeMirrorContent.setOption("mode",this.getCodeMirrorMode(t.type)):this.codeMirrorContent=CodeMirror(this.editorContentContainer,{value:"",lineNumbers:!0,mode:this.getCodeMirrorMode(t.type),theme:"default",lineWrapping:!0}),this.codeMirrorSrc||(this.codeMirrorSrc=CodeMirror(this.editorSrcContainer,{value:"",lineNumbers:!0,mode:"text",theme:"default",lineWrapping:!0})),t.type==="img"&&t.src?(this.activeEditTab="src",document.getElementById("tab-src").classList.add("active"),document.getElementById("tab-content").classList.remove("active"),document.getElementById("editor-src").style.display="block",document.getElementById("editor-content").style.display="none"):(this.activeEditTab="content",document.getElementById("tab-content").classList.add("active"),document.getElementById("tab-src").classList.remove("active"),document.getElementById("editor-content").style.display="block",document.getElementById("editor-src").style.display="none"),this.loadVersion(t,this.currentVersionIndex)}loadVersion(t,e){if(t.versions){if(e<t.versions.length){const n=t.versions[e];this.codeMirrorContent.setValue(n.content)}else this.codeMirrorContent.setValue(t.content||"");this.currentVersionIndex=e,this.renderVersionInfo(t)}}renderVersionInfo(t){const e=t.versions.length+1,n=this.currentVersionIndex+1;this.currentVersionIndex<t.versions.length?this.modalVersionsInfo.textContent=`Viewing Older Version ${n} of ${e}`:this.modalVersionsInfo.textContent=`Viewing Current Version ${n} of ${e}`}clearModalError(){this.modalError.textContent=""}showModalError(t){this.modalError.textContent=t}getCodeMirrorMode(t){switch(t){case"html":return"htmlmixed";case"markdown":return"markdown";case"text":return"javascript";default:return"javascript"}}async generateContent(t,e){const{type:n,id:s}=e,i=this.findEdgesByElementId(s).filter(r=>r.target===s).map(r=>({label:r.label,el:this.findElementById(r.source)}));console.log("Relevent edges",i);const o=this.getAuthToken();if(!o||o==="TBC")return await this.generateContentOld(t,n);try{const r=await fetch("https://c15r--2ac72f16e02411efa75ee6cdfca9ef9f.web.val.run",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({model:"claude-3-5-sonnet-20241022",max_tokens:4096,messages:[{role:"user",content:[{type:"text",text:`You will be given an element which is rendered into visual canvas. Either follow the user request or improve the provided content. The element content type should be <type>${n}</type>.

Please provide your response in two parts:
1. Your thought process about how to handle this request
2. The actual result/content

Here is the user request or content to process:

<related-context>
${i.map(l=>`<relation><label>${l.label||"undefined"}</label><content>${l.el.content}</content>`).join(`
`)}
<related-context>

<current-content>
${t}
</current-content>

Respond only with valid json (do not wrap in code block) following the ApiResponse schema:

<schema>
interface ApiResponse {
  thoughts: string;
  result: string;
}
<schema>
`}]}]})});console.log("response.ok",r.ok);const a=await r.text();console.log("AI response:",a);try{return JSON.parse(a).result}catch(l){return console.error("Failed to parse json response",l),null}}catch(r){return console.error("Error fetching AI response:",r),null}}async generateContentOld(t,e){try{return(await(await fetch("/api/ai_completion",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({instructions:`You will be given an element which is rendered into a visual canvas. 
Either follow the user request or improve the provided content. 
The element content type should be <content-type>${e}</content-type>.

Response should be valid JSON conforming to response schema:

<schema>
interface Response {
  thinking: string;
  result: string;
}
</schema>

<user_request_or_content>
${t}
</user_request_or_content>`})})).json()).result}catch(n){return console.error("Error fetching AI response (old fallback):",n),null}}rotateHandlePointerDown(t){if(t.stopPropagation(),this.mode!=="direct")return;const e=this.findElementById(this.selectedElementId);e&&(this.activeGesture="rotate-element",this.container.setPointerCapture(t.pointerId),this.elementStartRotation=e.rotation,this.centerForRotation={x:e.x+e.width/2,y:e.y+e.height/2},this.dragStartPos={x:t.clientX,y:t.clientY})}resizeHandlePointerDown(t){if(t.stopPropagation(),this.mode!=="direct")return;const e=this.findElementById(this.selectedElementId);!e||e.static===!0||(this.activeGesture="resize-element",this.container.setPointerCapture(t.pointerId),this.dragStartPos={x:t.clientX,y:t.clientY},this.elementStartSize={width:e.width,height:e.height},this.elementStartPos={x:e.x,y:e.y})}scaleHandlePointerDown(t){if(t.stopPropagation(),this.mode!=="direct")return;const e=this.findElementById(this.selectedElementId);e&&(this.activeGesture="scale-element",this.container.setPointerCapture(t.pointerId),this.dragStartPos={x:t.clientX,y:t.clientY},this.elementStartSize={width:e.width,height:e.height},this.elementStartPos={x:e.x,y:e.y})}reorderHandlePointerDown(t){if(t.stopPropagation(),this.mode!=="direct")return;const e=this.findElementById(this.selectedElementId);e&&(this.activeGesture="reorder-element",this.container.setPointerCapture(t.pointerId),this.dragStartPos={x:t.clientX,y:t.clientY},this.elementStartSize={width:e.width,height:e.height},this.elementStartPos={x:e.x,y:e.y})}typeHandlePointerDown(t){if(t.stopPropagation(),this.mode!=="direct"||!this.selectedElementId)return;const e=this.canvas.getBoundingClientRect();this.buildContextMenu(this.selectedElementId),this.showContextMenu(t.clientX-e.left,t.clientY-e.top)}edgeHandlePointerDown(t){if(t.stopPropagation(),this.mode!=="direct"||!this.selectedElementId)return;console.log("starting edge creation..."),this.activeGesture="create-edge",this.activeEdgeCreation={sourceId:this.selectedElementId,tempLine:null};const e=this.findElementById(this.activeEdgeCreation.sourceId);if(e){const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("stroke","blue"),n.setAttribute("stroke-width","4"),n.setAttribute("stroke-dasharray","5,5"),n.setAttribute("x1",e.x),n.setAttribute("y1",e.y),n.setAttribute("x2",e.x),n.setAttribute("y2",e.y),this.activeEdgeCreation.tempLine=n,this.edgesLayer.appendChild(n)}document.addEventListener("pointermove",this.edgePointerMoveHandler=n=>this.onEdgePointerMove(n)),document.addEventListener("pointerup",this.edgePointerUpHandler=n=>this.onEdgePointerUp(n))}onEdgePointerMove(t){if(console.log("onEdgePointerMove(ev)"),this.activeGesture!=="create-edge"||!this.activeEdgeCreation)return;const e=this.screenToCanvas(t.clientX,t.clientY);this.activeEdgeCreation.tempLine.setAttribute("x2",e.x),this.activeEdgeCreation.tempLine.setAttribute("y2",e.y)}onEdgePointerUp(t){if(console.log("onEdgePointerUp(ev)",this.activeGesture,this.activeEdgeCreation),this.activeGesture!=="create-edge"||!this.activeEdgeCreation)return;const e=document.elementFromPoint(t.clientX,t.clientY);let n=e&&e.closest(".canvas-element");if(console.log("targetEl",e,n),n){const s=n.dataset.elId;s&&s!==this.activeEdgeCreation.sourceId&&this.createNewEdge(this.activeEdgeCreation.sourceId,s,"")}this.activeEdgeCreation.tempLine&&this.activeEdgeCreation.tempLine.remove(),this.activeEdgeCreation=null,this.activeGesture=null,document.removeEventListener("pointermove",this.edgePointerMoveHandler),document.removeEventListener("pointerup",this.edgePointerUpHandler),this.renderElements(),this.saveCanvas()}createNewEdge(t,e,n,s={},i={}){const o={id:"edge-"+Date.now(),source:t,target:e,label:n,style:{...i},data:{...s}};this.canvasState.edges.push(o)}serializeCanvas(){return JSON.stringify(this.canvasState)}async saveCanvas(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>{this._saveCanvas()},this.debounceSaveDelay)}async _saveCanvas(){this.saveCanvasLocalOnly();const t=this.getAuthToken();if(!t){console.warn("No auth token found, skipping API save");return}const e=this.canvasState.canvasId,n="websim";try{const i=await(await fetch(`https://c15r-parcland_backpack.web.val.run/${n}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:this.serializeCanvas()})).json();console.log(`Canvas ${e} saved to API`,i)}catch(s){console.error(`Error saving canvas ${e} to API:`,s)}}async setBackpackItem(t,e){const n=this.getAuthToken();if(!n){console.warn("No auth token found, skipping API save");return}try{const i=await(await fetch(`https://c15r-parcland_backpack.web.val.run/parc.land/${t}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:e})).json();console.log(`Backpack item ${t} saved to API`,i)}catch(s){console.error(`Error saving backpack item ${t} to API:`,s)}}saveCanvasLocalOnly(){localStorage.setItem("myCanvasData_"+this.canvasState.canvasId,this.serializeCanvas())}getAuthToken(){const t=this.tokenKey;let e=localStorage.getItem(t);return e||(localStorage.setItem(t,"TBC"),e="TBC"),e}}let u=null;(async function(){const t=new URLSearchParams(window.location.search),e=t.get("canvas")||"canvas-002",n=t.get("token");let s={canvasId:e,elements:[],edges:[],versionHistory:[]};s=await E(s,n),u=new y(s,null)})();async function E(g,t){const e="PARC.LAND/BKPK_TOKEN";let n=t||localStorage.getItem(e);n||(n="TBC"),localStorage.setItem(e,n);const s=localStorage.getItem("myCanvasData_"+g.canvasId);try{const o=await fetch(`https://c15r-parcland_backpack.web.val.run/websim/${g.canvasId}`,{headers:{Authorization:`Bearer ${n}`}});return o.ok?await o.json():(console.warn("Failed to load from API, fallback local"),s?JSON.parse(s):g)}catch(i){return console.error("Error loading from API",i),s?JSON.parse(s):g}}
